<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Otel Y√∂netim Paneli Pro</title>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">// ============================================
// OTEL Y√ñNETƒ∞M PANELƒ∞ V2.0 - YENƒ∞ √ñZELLƒ∞KLER
// ============================================

// Global deƒüi≈ükenler
let successThreshold = 80; // Ba≈üarƒ± barajƒ±
let emailTemplate = ''; // Mail taslaƒüƒ±
let selectedSurveyIds = new Set(); // Se√ßili anketler

// ============================================
// 1. KULLANICI YETKƒ∞ Y√ñNETƒ∞Mƒ∞
// ============================================

window.changeUserRole = async function(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    const user = allUsers.find(u => u.id === userId);
    
    if (!confirm(`"${user.username}" kullanƒ±cƒ±sƒ±nƒ±n rol√ºn√º "${currentRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" -> "${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" olarak deƒüi≈ütirmek istiyor musunuz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('users')
            .update({ role: newRole })
            .eq('id', userId);
        
        if (error) throw error;
        
        // Local state'i g√ºncelle
        user.role = newRole;
        renderUsers();
        alert(`‚úÖ ${user.username} artƒ±k ${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}`);
        
    } catch (e) {
        console.error('Rol deƒüi≈ütirme hatasƒ±:', e);
        alert('‚ùå Rol deƒüi≈ütirilemedi: ' + e.message);
    }
}

// ============================================
// 2. PDF EXPORT FONKSƒ∞YONLARI
// ============================================

window.exportGeneralReportPDF = async function() {
    const element = document.getElementById('generalReportContainer');
    if (!element) {
        alert('‚ö†Ô∏è √ñnce rapor olu≈üturun!');
        return;
    }
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`Genel_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

window.exportDepartmentReportPDF = async function() {
    const element = document.getElementById('deptReportContainer');
    if (!element || !element.innerHTML) {
        alert('‚ö†Ô∏è √ñnce departman raporu olu≈üturun!');
        return;
    }
    
    const deptKey = document.getElementById('deptSelect').value;
    const dept = DEPTS.find(d => d.key === deptKey);
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        pdf.save(`${dept.name}_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

// ============================================
// 3. BA≈ûARI BARAJI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadSuccessThreshold() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'success_threshold')
            .single();
        
        if (data && data.setting_value) {
            successThreshold = parseInt(data.setting_value);
            const input = document.getElementById('successThresholdInput');
            if (input) input.value = successThreshold;
            console.log('‚úÖ Ba≈üarƒ± barajƒ± y√ºklendi:', successThreshold);
        }
    } catch (e) {
        console.log('Ba≈üarƒ± barajƒ± ayarƒ± yok, varsayƒ±lan kullanƒ±lƒ±yor:', successThreshold);
    }
}

window.saveSuccessThreshold = async function() {
    const value = parseInt(document.getElementById('successThresholdInput').value);
    const errEl = document.getElementById('thresholdError');
    const statusEl = document.getElementById('thresholdStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (isNaN(value) || value < 50 || value > 100) {
        errEl.textContent = '‚ö†Ô∏è Ba≈üarƒ± barajƒ± 50-100 arasƒ±nda olmalƒ±!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'success_threshold',
                setting_value: value.toString(),
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        successThreshold = value;
        statusEl.style.display = 'block';
        statusEl.textContent = `‚úÖ Ba≈üarƒ± barajƒ± %${value} olarak kaydedildi!`;
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
        // Raporlarƒ± yenile
        if (document.getElementById('reports').classList.contains('active')) {
            generateReport();
        }
        
    } catch (e) {
        console.error('Ba≈üarƒ± barajƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

// ============================================
// 4. MAƒ∞L Sƒ∞LME FONKSƒ∞YONLARI
// ============================================

window.toggleSurveySelect = function(surveyId, checkbox) {
    if (checkbox.checked) {
        selectedSurveyIds.add(surveyId);
    } else {
        selectedSurveyIds.delete(surveyId);
    }
    
    // Toplu silme butonunu g√∂ster/gizle
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.toggleSelectAll = function(checkbox) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    selectedSurveyIds.clear();
    
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedSurveyIds.add(cb.dataset.surveyId);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.deleteSurvey = async function(surveyId, email) {
    if (!confirm(`"${email}" adresine ait anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('surveys')
            .delete()
            .eq('id', surveyId);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => s.id !== surveyId);
        selectedSurveyIds.delete(surveyId);
        
        renderEmails();
        updateDashboard();
        alert('‚úÖ Anket silindi!');
        
    } catch (e) {
        console.error('Anket silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

window.deleteSelectedSurveys = async function() {
    if (selectedSurveyIds.size === 0) return;
    
    if (!confirm(`${selectedSurveyIds.size} anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const idsArray = Array.from(selectedSurveyIds);
        
        const { error } = await supabase
            .from('surveys')
            .delete()
            .in('id', idsArray);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => !selectedSurveyIds.has(s.id));
        selectedSurveyIds.clear();
        
        renderEmails();
        updateDashboard();
        alert(`‚úÖ ${idsArray.length} anket silindi!`);
        
    } catch (e) {
        console.error('Toplu silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

// ============================================
// 5. MAƒ∞L TASLAƒûI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadEmailTemplate() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'email_template')
            .single();
        
        if (data && data.setting_value) {
            emailTemplate = data.setting_value;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
            console.log('‚úÖ Mail taslaƒüƒ± y√ºklendi');
        } else {
            // Varsayƒ±lan taslak
            emailTemplate = `Merhaba,

{{hotel_name}}'de konaklama deneyiminizi bizimle payla≈ütƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz!

Memnuniyetinizden dolayƒ± √ßok mutluyuz. Deneyiminizi Google'da yorum yaparak diƒüer misafirlerimizle payla≈üƒ±r mƒ±sƒ±nƒ±z?

Google Yorumlarƒ±mƒ±z: https://g.page/r/YOUR_PLACE_ID/review

Zamanƒ±nƒ±z i√ßin te≈üekk√ºrler!

Sevgilerle,
{{hotel_name}}`;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
        }
    } catch (e) {
        console.log('Mail taslaƒüƒ± y√ºkleme hatasƒ±:', e);
    }
}

window.saveEmailTemplate = async function() {
    const value = document.getElementById('emailTemplateTextarea').value.trim();
    const errEl = document.getElementById('templateError');
    const statusEl = document.getElementById('templateStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (!value) {
        errEl.textContent = '‚ö†Ô∏è Mail taslaƒüƒ± bo≈ü olamaz!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'email_template',
                setting_value: value,
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        emailTemplate = value;
        statusEl.style.display = 'block';
        statusEl.textContent = '‚úÖ Mail taslaƒüƒ± kaydedildi!';
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
    } catch (e) {
        console.error('Mail taslaƒüƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

window.previewEmailTemplate = function() {
    const template = document.getElementById('emailTemplateTextarea').value;
    const hotelName = document.getElementById('emailjsFromName').value || 'Noxinn Deluxe Hotel';
    
    const preview = template
        .replace(/{{hotel_name}}/g, hotelName)
        .replace(/{{room_number}}/g, '101')
        .replace(/{{guest_name}}/g, 'Sayƒ±n Misafirimiz');
    
    alert(`üìß Mail √ñnizleme:\n\n${preview}`);
}

// ============================================
// SAYFA Y√úKLENME OLAYLARI
// ============================================



// ƒ∞lk y√ºklemede ayarlarƒ± y√ºkle
window.addEventListener('DOMContentLoaded', () => {
    loadSuccessThreshold();
    loadEmailTemplate();
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">// ============================================
// OTEL Y√ñNETƒ∞M PANELƒ∞ V2.0 - YENƒ∞ √ñZELLƒ∞KLER
// ============================================

// Global deƒüi≈ükenler
let successThreshold = 80; // Ba≈üarƒ± barajƒ±
let emailTemplate = ''; // Mail taslaƒüƒ±
let selectedSurveyIds = new Set(); // Se√ßili anketler

// ============================================
// 1. KULLANICI YETKƒ∞ Y√ñNETƒ∞Mƒ∞
// ============================================

window.changeUserRole = async function(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    const user = allUsers.find(u => u.id === userId);
    
    if (!confirm(`"${user.username}" kullanƒ±cƒ±sƒ±nƒ±n rol√ºn√º "${currentRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" -> "${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" olarak deƒüi≈ütirmek istiyor musunuz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('users')
            .update({ role: newRole })
            .eq('id', userId);
        
        if (error) throw error;
        
        // Local state'i g√ºncelle
        user.role = newRole;
        renderUsers();
        alert(`‚úÖ ${user.username} artƒ±k ${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}`);
        
    } catch (e) {
        console.error('Rol deƒüi≈ütirme hatasƒ±:', e);
        alert('‚ùå Rol deƒüi≈ütirilemedi: ' + e.message);
    }
}

// ============================================
// 2. PDF EXPORT FONKSƒ∞YONLARI
// ============================================

window.exportGeneralReportPDF = async function() {
    const element = document.getElementById('generalReportContainer');
    if (!element) {
        alert('‚ö†Ô∏è √ñnce rapor olu≈üturun!');
        return;
    }
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`Genel_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

window.exportDepartmentReportPDF = async function() {
    const element = document.getElementById('deptReportContainer');
    if (!element || !element.innerHTML) {
        alert('‚ö†Ô∏è √ñnce departman raporu olu≈üturun!');
        return;
    }
    
    const deptKey = document.getElementById('deptSelect').value;
    const dept = DEPTS.find(d => d.key === deptKey);
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        pdf.save(`${dept.name}_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

// ============================================
// 3. BA≈ûARI BARAJI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadSuccessThreshold() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'success_threshold')
            .single();
        
        if (data && data.setting_value) {
            successThreshold = parseInt(data.setting_value);
            const input = document.getElementById('successThresholdInput');
            if (input) input.value = successThreshold;
            console.log('‚úÖ Ba≈üarƒ± barajƒ± y√ºklendi:', successThreshold);
        }
    } catch (e) {
        console.log('Ba≈üarƒ± barajƒ± ayarƒ± yok, varsayƒ±lan kullanƒ±lƒ±yor:', successThreshold);
    }
}

window.saveSuccessThreshold = async function() {
    const value = parseInt(document.getElementById('successThresholdInput').value);
    const errEl = document.getElementById('thresholdError');
    const statusEl = document.getElementById('thresholdStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (isNaN(value) || value < 50 || value > 100) {
        errEl.textContent = '‚ö†Ô∏è Ba≈üarƒ± barajƒ± 50-100 arasƒ±nda olmalƒ±!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'success_threshold',
                setting_value: value.toString(),
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        successThreshold = value;
        statusEl.style.display = 'block';
        statusEl.textContent = `‚úÖ Ba≈üarƒ± barajƒ± %${value} olarak kaydedildi!`;
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
        // Raporlarƒ± yenile
        if (document.getElementById('reports').classList.contains('active')) {
            generateReport();
        }
        
    } catch (e) {
        console.error('Ba≈üarƒ± barajƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

// ============================================
// 4. MAƒ∞L Sƒ∞LME FONKSƒ∞YONLARI
// ============================================

window.toggleSurveySelect = function(surveyId, checkbox) {
    if (checkbox.checked) {
        selectedSurveyIds.add(surveyId);
    } else {
        selectedSurveyIds.delete(surveyId);
    }
    
    // Toplu silme butonunu g√∂ster/gizle
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.toggleSelectAll = function(checkbox) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    selectedSurveyIds.clear();
    
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedSurveyIds.add(cb.dataset.surveyId);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.deleteSurvey = async function(surveyId, email) {
    if (!confirm(`"${email}" adresine ait anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('surveys')
            .delete()
            .eq('id', surveyId);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => s.id !== surveyId);
        selectedSurveyIds.delete(surveyId);
        
        renderEmails();
        updateDashboard();
        alert('‚úÖ Anket silindi!');
        
    } catch (e) {
        console.error('Anket silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

window.deleteSelectedSurveys = async function() {
    if (selectedSurveyIds.size === 0) return;
    
    if (!confirm(`${selectedSurveyIds.size} anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const idsArray = Array.from(selectedSurveyIds);
        
        const { error } = await supabase
            .from('surveys')
            .delete()
            .in('id', idsArray);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => !selectedSurveyIds.has(s.id));
        selectedSurveyIds.clear();
        
        renderEmails();
        updateDashboard();
        alert(`‚úÖ ${idsArray.length} anket silindi!`);
        
    } catch (e) {
        console.error('Toplu silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

// ============================================
// 5. MAƒ∞L TASLAƒûI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadEmailTemplate() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'email_template')
            .single();
        
        if (data && data.setting_value) {
            emailTemplate = data.setting_value;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
            console.log('‚úÖ Mail taslaƒüƒ± y√ºklendi');
        } else {
            // Varsayƒ±lan taslak
            emailTemplate = `Merhaba,

{{hotel_name}}'de konaklama deneyiminizi bizimle payla≈ütƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz!

Memnuniyetinizden dolayƒ± √ßok mutluyuz. Deneyiminizi Google'da yorum yaparak diƒüer misafirlerimizle payla≈üƒ±r mƒ±sƒ±nƒ±z?

Google Yorumlarƒ±mƒ±z: https://g.page/r/YOUR_PLACE_ID/review

Zamanƒ±nƒ±z i√ßin te≈üekk√ºrler!

Sevgilerle,
{{hotel_name}}`;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
        }
    } catch (e) {
        console.log('Mail taslaƒüƒ± y√ºkleme hatasƒ±:', e);
    }
}

window.saveEmailTemplate = async function() {
    const value = document.getElementById('emailTemplateTextarea').value.trim();
    const errEl = document.getElementById('templateError');
    const statusEl = document.getElementById('templateStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (!value) {
        errEl.textContent = '‚ö†Ô∏è Mail taslaƒüƒ± bo≈ü olamaz!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'email_template',
                setting_value: value,
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        emailTemplate = value;
        statusEl.style.display = 'block';
        statusEl.textContent = '‚úÖ Mail taslaƒüƒ± kaydedildi!';
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
    } catch (e) {
        console.error('Mail taslaƒüƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

window.previewEmailTemplate = function() {
    const template = document.getElementById('emailTemplateTextarea').value;
    const hotelName = document.getElementById('emailjsFromName').value || 'Noxinn Deluxe Hotel';
    
    const preview = template
        .replace(/{{hotel_name}}/g, hotelName)
        .replace(/{{room_number}}/g, '101')
        .replace(/{{guest_name}}/g, 'Sayƒ±n Misafirimiz');
    
    alert(`üìß Mail √ñnizleme:\n\n${preview}`);
}

// ============================================
// SAYFA Y√úKLENME OLAYLARI
// ============================================



// ƒ∞lk y√ºklemede ayarlarƒ± y√ºkle
window.addEventListener('DOMContentLoaded', () => {
    loadSuccessThreshold();
    loadEmailTemplate();
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js">// ============================================
// OTEL Y√ñNETƒ∞M PANELƒ∞ V2.0 - YENƒ∞ √ñZELLƒ∞KLER
// ============================================

// Global deƒüi≈ükenler
let successThreshold = 80; // Ba≈üarƒ± barajƒ±
let emailTemplate = ''; // Mail taslaƒüƒ±
let selectedSurveyIds = new Set(); // Se√ßili anketler

// ============================================
// 1. KULLANICI YETKƒ∞ Y√ñNETƒ∞Mƒ∞
// ============================================

window.changeUserRole = async function(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    const user = allUsers.find(u => u.id === userId);
    
    if (!confirm(`"${user.username}" kullanƒ±cƒ±sƒ±nƒ±n rol√ºn√º "${currentRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" -> "${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" olarak deƒüi≈ütirmek istiyor musunuz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('users')
            .update({ role: newRole })
            .eq('id', userId);
        
        if (error) throw error;
        
        // Local state'i g√ºncelle
        user.role = newRole;
        renderUsers();
        alert(`‚úÖ ${user.username} artƒ±k ${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}`);
        
    } catch (e) {
        console.error('Rol deƒüi≈ütirme hatasƒ±:', e);
        alert('‚ùå Rol deƒüi≈ütirilemedi: ' + e.message);
    }
}

// ============================================
// 2. PDF EXPORT FONKSƒ∞YONLARI
// ============================================

window.exportGeneralReportPDF = async function() {
    const element = document.getElementById('generalReportContainer');
    if (!element) {
        alert('‚ö†Ô∏è √ñnce rapor olu≈üturun!');
        return;
    }
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`Genel_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

window.exportDepartmentReportPDF = async function() {
    const element = document.getElementById('deptReportContainer');
    if (!element || !element.innerHTML) {
        alert('‚ö†Ô∏è √ñnce departman raporu olu≈üturun!');
        return;
    }
    
    const deptKey = document.getElementById('deptSelect').value;
    const dept = DEPTS.find(d => d.key === deptKey);
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        pdf.save(`${dept.name}_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

// ============================================
// 3. BA≈ûARI BARAJI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadSuccessThreshold() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'success_threshold')
            .single();
        
        if (data && data.setting_value) {
            successThreshold = parseInt(data.setting_value);
            const input = document.getElementById('successThresholdInput');
            if (input) input.value = successThreshold;
            console.log('‚úÖ Ba≈üarƒ± barajƒ± y√ºklendi:', successThreshold);
        }
    } catch (e) {
        console.log('Ba≈üarƒ± barajƒ± ayarƒ± yok, varsayƒ±lan kullanƒ±lƒ±yor:', successThreshold);
    }
}

window.saveSuccessThreshold = async function() {
    const value = parseInt(document.getElementById('successThresholdInput').value);
    const errEl = document.getElementById('thresholdError');
    const statusEl = document.getElementById('thresholdStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (isNaN(value) || value < 50 || value > 100) {
        errEl.textContent = '‚ö†Ô∏è Ba≈üarƒ± barajƒ± 50-100 arasƒ±nda olmalƒ±!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'success_threshold',
                setting_value: value.toString(),
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        successThreshold = value;
        statusEl.style.display = 'block';
        statusEl.textContent = `‚úÖ Ba≈üarƒ± barajƒ± %${value} olarak kaydedildi!`;
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
        // Raporlarƒ± yenile
        if (document.getElementById('reports').classList.contains('active')) {
            generateReport();
        }
        
    } catch (e) {
        console.error('Ba≈üarƒ± barajƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

// ============================================
// 4. MAƒ∞L Sƒ∞LME FONKSƒ∞YONLARI
// ============================================

window.toggleSurveySelect = function(surveyId, checkbox) {
    if (checkbox.checked) {
        selectedSurveyIds.add(surveyId);
    } else {
        selectedSurveyIds.delete(surveyId);
    }
    
    // Toplu silme butonunu g√∂ster/gizle
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.toggleSelectAll = function(checkbox) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    selectedSurveyIds.clear();
    
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedSurveyIds.add(cb.dataset.surveyId);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.deleteSurvey = async function(surveyId, email) {
    if (!confirm(`"${email}" adresine ait anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('surveys')
            .delete()
            .eq('id', surveyId);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => s.id !== surveyId);
        selectedSurveyIds.delete(surveyId);
        
        renderEmails();
        updateDashboard();
        alert('‚úÖ Anket silindi!');
        
    } catch (e) {
        console.error('Anket silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

window.deleteSelectedSurveys = async function() {
    if (selectedSurveyIds.size === 0) return;
    
    if (!confirm(`${selectedSurveyIds.size} anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const idsArray = Array.from(selectedSurveyIds);
        
        const { error } = await supabase
            .from('surveys')
            .delete()
            .in('id', idsArray);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => !selectedSurveyIds.has(s.id));
        selectedSurveyIds.clear();
        
        renderEmails();
        updateDashboard();
        alert(`‚úÖ ${idsArray.length} anket silindi!`);
        
    } catch (e) {
        console.error('Toplu silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

// ============================================
// 5. MAƒ∞L TASLAƒûI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadEmailTemplate() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'email_template')
            .single();
        
        if (data && data.setting_value) {
            emailTemplate = data.setting_value;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
            console.log('‚úÖ Mail taslaƒüƒ± y√ºklendi');
        } else {
            // Varsayƒ±lan taslak
            emailTemplate = `Merhaba,

{{hotel_name}}'de konaklama deneyiminizi bizimle payla≈ütƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz!

Memnuniyetinizden dolayƒ± √ßok mutluyuz. Deneyiminizi Google'da yorum yaparak diƒüer misafirlerimizle payla≈üƒ±r mƒ±sƒ±nƒ±z?

Google Yorumlarƒ±mƒ±z: https://g.page/r/YOUR_PLACE_ID/review

Zamanƒ±nƒ±z i√ßin te≈üekk√ºrler!

Sevgilerle,
{{hotel_name}}`;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
        }
    } catch (e) {
        console.log('Mail taslaƒüƒ± y√ºkleme hatasƒ±:', e);
    }
}

window.saveEmailTemplate = async function() {
    const value = document.getElementById('emailTemplateTextarea').value.trim();
    const errEl = document.getElementById('templateError');
    const statusEl = document.getElementById('templateStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (!value) {
        errEl.textContent = '‚ö†Ô∏è Mail taslaƒüƒ± bo≈ü olamaz!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'email_template',
                setting_value: value,
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        emailTemplate = value;
        statusEl.style.display = 'block';
        statusEl.textContent = '‚úÖ Mail taslaƒüƒ± kaydedildi!';
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
    } catch (e) {
        console.error('Mail taslaƒüƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

window.previewEmailTemplate = function() {
    const template = document.getElementById('emailTemplateTextarea').value;
    const hotelName = document.getElementById('emailjsFromName').value || 'Noxinn Deluxe Hotel';
    
    const preview = template
        .replace(/{{hotel_name}}/g, hotelName)
        .replace(/{{room_number}}/g, '101')
        .replace(/{{guest_name}}/g, 'Sayƒ±n Misafirimiz');
    
    alert(`üìß Mail √ñnizleme:\n\n${preview}`);
}

// ============================================
// SAYFA Y√úKLENME OLAYLARI
// ============================================



// ƒ∞lk y√ºklemede ayarlarƒ± y√ºkle
window.addEventListener('DOMContentLoaded', () => {
    loadSuccessThreshold();
    loadEmailTemplate();
});

</script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#1e3c72,#2a5298);min-height:100vh}
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px}
.login-box{background:white;border-radius:24px;padding:50px 40px;max-width:420px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.3);text-align:center}
.login-box .logo{font-size:56px;margin-bottom:10px}
.login-box h1{color:#1e3c72;font-size:24px;margin-bottom:6px}
.login-box .sub{color:#888;font-size:14px;margin-bottom:30px}
.login-input{width:100%;padding:14px 18px;border:2px solid #e0e0e0;border-radius:10px;font-size:15px;font-family:inherit;margin-bottom:14px;transition:border-color .3s}
.login-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s;margin-top:6px}
.login-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(102,126,234,.4)}
.login-btn:disabled{opacity:.5;cursor:not-allowed}
.login-error{background:#fee2e2;color:#dc2626;border:2px solid #ef4444;padding:10px 14px;border-radius:8px;font-size:13px;display:none;margin-bottom:16px}
.login-error.show{display:block}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:240px;background:#1a2332;padding:20px 0;box-shadow:4px 0 10px rgba(0,0,0,.2);z-index:1000}
.sidebar-logo{padding:0 20px 18px;border-bottom:1px solid rgba(255,255,255,.1);margin-bottom:18px}
.sidebar-logo h1{color:white;font-size:20px;display:flex;align-items:center;gap:10px}
.menu-item{padding:13px 20px;color:rgba(255,255,255,.65);cursor:pointer;transition:all .25s;display:flex;align-items:center;gap:12px;font-size:14px;border-left:3px solid transparent}
.menu-item:hover{background:rgba(255,255,255,.06);color:white}
.menu-item.active{background:rgba(102,126,234,.2);color:white;border-left-color:#667eea}
.menu-item .icon{font-size:18px;width:22px;text-align:center}
.sidebar-bottom{position:absolute;bottom:0;left:0;right:0;padding:14px 20px;border-top:1px solid rgba(255,255,255,.1)}
.user-info{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:14px}
.user-name{color:white;font-size:13px;font-weight:600}
.user-role{color:rgba(255,255,255,.5);font-size:11px}
.logout-btn{width:100%;padding:8px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7);border-radius:6px;font-size:12px;cursor:pointer;transition:all .2s}
.logout-btn:hover{background:rgba(239,68,68,.3);color:white}
.main{margin-left:240px;padding:28px;min-height:100vh}
.page{display:none}
.page.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.page-header{background:white;padding:22px 28px;border-radius:14px;margin-bottom:22px;box-shadow:0 3px 16px rgba(0,0,0,.08)}
.page-header h2{color:#1e3c72;font-size:24px;margin-bottom:4px}
.page-header p{color:#777;font-size:14px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:22px}
.stat-card{background:white;padding:22px;border-radius:14px;box-shadow:0 3px 14px rgba(0,0,0,.08);transition:all .25s}
.stat-card:hover{transform:translateY(-4px);box-shadow:0 8px 22px rgba(0,0,0,.12)}
.stat-card .s-icon{font-size:30px;margin-bottom:8px}
.stat-card .s-label{font-size:12px;color:#888;margin-bottom:6px}
.stat-card .s-value{font-size:28px;font-weight:700;color:#1e3c72}
.stat-card.success .s-value{color:#10b981}
.stat-card.warning .s-value{color:#f59e0b}
.stat-card.danger .s-value{color:#ef4444}
.controls{background:white;padding:16px 20px;border-radius:10px;margin-bottom:18px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.ctrl-group{display:flex;flex-direction:column;gap:4px}
.ctrl-group label{font-size:12px;color:#888;font-weight:600}
input[type="date"],input[type="text"],input[type="email"],input[type="password"],select,textarea{padding:9px 12px;border:2px solid #e0e0e0;border-radius:7px;font-size:13px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea}
.filter-btn{padding:8px 16px;border:2px solid #e0e0e0;background:white;border-radius:7px;cursor:pointer;font-size:13px;font-weight:600;color:#666;transition:all .2s}
.filter-btn.active{background:#1e3c72;color:white;border-color:#1e3c72}
.filter-btn:hover{border-color:#667eea}
.btn{padding:9px 20px;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;transition:all .25s}
.btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 5px 16px rgba(102,126,234,.4)}
.btn-success{background:#10b981;color:white}
.btn-success:hover{background:#059669}
.btn-danger{background:#ef4444;color:white;font-size:11px;padding:6px 12px}
.btn-danger:hover{background:#dc2626}
.btn-warning{background:#f59e0b;color:white;font-size:11px;padding:6px 12px}
.btn-warning:hover{background:#d97706}
.btn-info{background:#3b82f6;color:white;font-size:11px;padding:6px 12px}
.btn-info:hover{background:#2563eb}
.divider{border-left:2px solid #e8e8e8;height:28px}
.quick-actions{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:22px}
.action-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:22px;border-radius:14px;cursor:pointer;transition:all .25s;text-align:center}
.action-card:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(102,126,234,.4)}
.action-card .a-icon{font-size:40px;margin-bottom:8px}
.action-card h3{font-size:16px;margin-bottom:4px}
.action-card p{font-size:12px;opacity:.85}
.chart-wrap{background:white;padding:22px;border-radius:14px;margin-bottom:22px;box-shadow:0 3px 14px rgba(0,0,0,.08)}
.chart-wrap h3{color:#1e3c72;margin-bottom:16px;font-size:17px}
.bar-chart{display:flex;align-items:flex-end;justify-content:space-around;height:220px;gap:10px;padding:16px 0 30px}
.bar{flex:1;border-radius:6px 6px 0 0;position:relative;transition:all .5s;min-width:30px;cursor:pointer}
.bar.green{background:linear-gradient(to top,#10b981,#059669)}
.bar.red{background:linear-gradient(to top,#ef4444,#dc2626)}
.bar:hover{opacity:.75;transform:translateY(-4px)}
.bar-label{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:10px;color:#666;white-space:nowrap;font-weight:600;text-align:center}
.bar-value{position:absolute;top:-20px;left:50%;transform:translateX(-50%);font-weight:700;font-size:12px}
.bar-value.green{color:#10b981}
.bar-value.red{color:#ef4444}
.dept-card{background:white;border-radius:14px;padding:22px;box-shadow:0 3px 14px rgba(0,0,0,.08);margin-bottom:16px;transition:all .25s}
.dept-card:hover{transform:translateY(-3px);box-shadow:0 7px 22px rgba(0,0,0,.12)}
.dept-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #f0f0f0}
.dept-name{font-size:18px;font-weight:700;color:#333}
.dept-score{font-size:36px;font-weight:700;padding:6px 16px;border-radius:10px}
.dept-score.excellent{color:#10b981;background:#d1fae5}
.dept-score.danger{color:#ef4444;background:#fee2e2}
.dept-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:14px}
.detail-item{text-align:center;padding:10px;background:#f8f9ff;border-radius:8px}
.detail-item .label{font-size:10px;color:#888;margin-bottom:4px}
.detail-item .value{font-size:18px;font-weight:700;color:#1e3c72}
.progress-bar{width:100%;height:22px;background:#e8e8e8;border-radius:11px;overflow:hidden}
.progress-fill{height:100%;transition:width 1s;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:12px}
.progress-fill.excellent{background:linear-gradient(135deg,#10b981,#059669)}
.progress-fill.danger{background:linear-gradient(135deg,#ef4444,#dc2626)}
.survey-card{background:white;border-radius:14px;padding:18px;box-shadow:0 3px 14px rgba(0,0,0,.08);margin-bottom:14px;position:relative;overflow:hidden}
.survey-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
.survey-card.excellent::before{background:#10b981}
.survey-card.average::before{background:#f59e0b}
.survey-card.poor::before{background:#ef4444}
.survey-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.room-badge{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:7px 14px;border-radius:8px;font-size:16px;font-weight:700}
.badge-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.date-badge{background:#f3f4f6;padding:5px 10px;border-radius:6px;font-size:11px;color:#666}
.alert-badge{padding:4px 9px;border-radius:5px;font-size:10px;font-weight:700}
.alert-badge.warning{background:#fef3c7;color:#d97706}
.alert-badge.danger{background:#fee2e2;color:#dc2626;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.55}}
.ratings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px;margin-bottom:10px}
.rating-item{text-align:center;padding:8px 4px;background:#f8f9ff;border-radius:7px}
.rating-item .r-icon{font-size:18px;margin-bottom:2px}
.rating-item .r-label{font-size:9px;color:#888;margin-bottom:2px}
.rating-item .r-stars{font-size:12px}
.comments-section{background:#f8f9ff;padding:10px 14px;border-radius:8px;border-left:3px solid #667eea;margin-top:8px}
.comments-section .c-title{color:#667eea;font-size:12px;font-weight:600;margin-bottom:5px}
.comments-section p{color:#444;font-size:13px;line-height:1.5}
.date-group-header{background:white;padding:12px 18px;border-radius:10px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(0,0,0,.06)}
.date-group-header h3{color:#1e3c72;font-size:16px;margin:0}
.date-group-header span{background:#f3f4f6;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600}
.users-table,.emails-table{background:white;border-radius:14px;overflow:hidden;box-shadow:0 3px 14px rgba(0,0,0,.08);margin-bottom:20px}
.users-table table,.emails-table table{width:100%;border-collapse:collapse}
.users-table th,.emails-table th{background:#f8f9ff;padding:12px 16px;text-align:left;font-size:12px;color:#888;font-weight:600;border-bottom:2px solid #eee}
.users-table td,.emails-table td{padding:12px 16px;border-bottom:1px solid #f0f0f0;font-size:14px;color:#333}
.users-table tr:last-child td,.emails-table tr:last-child td{border-bottom:none}
.role-badge{padding:3px 10px;border-radius:5px;font-size:11px;font-weight:600}
.role-badge.admin{background:#d1fae5;color:#059669}
.role-badge.user{background:#dbeafe;color:#2563eb}
.add-user-form{background:white;padding:22px;border-radius:14px;box-shadow:0 3px 14px rgba(0,0,0,.08);margin-bottom:20px}
.add-user-form h3{color:#1e3c72;font-size:17px;margin-bottom:16px}
.form-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.form-row input,.form-row select{flex:1;min-width:140px}
.empty-state{background:white;border-radius:14px;padding:50px 20px;text-align:center;box-shadow:0 3px 14px rgba(0,0,0,.08)}
.empty-state .e-icon{font-size:56px;margin-bottom:14px}
.empty-state h2{color:#444;font-size:18px;margin-bottom:6px}
.empty-state p{color:#999;font-size:14px}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal-content{background:white;border-radius:16px;padding:30px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3)}
.modal-content h3{color:#1e3c72;margin-bottom:16px;font-size:20px}
.modal-content textarea{width:100%;min-height:120px;margin-bottom:16px}
.modal-buttons{display:flex;gap:12px;justify-content:flex-end}
.role-badge{padding:4px 12px;border-radius:12px;font-size:11px;font-weight:600;display:inline-block}
.role-badge.admin{background:#dbeafe;color:#1e40af}
.role-badge.user{background:#f3f4f6;color:#6b7280}
.email-checkbox{width:18px;height:18px;cursor:pointer;margin:0}
.select-all-checkbox{width:18px;height:18px;cursor:pointer}
.bulk-actions{background:#f8f9ff;padding:12px 20px;border-radius:10px;margin-bottom:16px;display:none;align-items:center;gap:12px;border:2px solid #e0e6ff}
.bulk-actions.show{display:flex}
.pdf-export-btn{background:#dc2626;color:white;padding:9px 20px;border:none;border-radius:7px;font-size:13px;font-weight:600;cursor:pointer;transition:all .25s}
.pdf-export-btn:hover{background:#b91c1c;transform:translateY(-2px);box-shadow:0 5px 16px rgba(220,38,38,.4)}
@media(max-width:900px){.sidebar{width:64px}.sidebar-logo h1 span:last-child{display:none}.menu-item span:last-child{display:none}.sidebar-bottom .user-name,.sidebar-bottom .user-role,.sidebar-bottom .logout-btn{display:none}.main{margin-left:64px;padding:18px}}
@media(max-width:600px){.sidebar{width:100%;height:auto;position:relative;display:flex;overflow-x:auto;padding:10px}.sidebar-logo{display:none}.menu-item{flex-direction:column;padding:8px 12px;font-size:10px;gap:4px}.sidebar-bottom{display:none}.main{margin-left:0;padding:12px}}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
<div class="login-box">
<div class="logo">üè®</div>
<h1>Otel Y√∂netim Paneli Pro</h1>
<p class="sub">Y√∂netici hesabƒ±nƒ±zla giri≈ü yapƒ±n</p>
<div class="login-error" id="loginError"></div>
<input class="login-input" type="text" id="loginUser" placeholder="Kullanƒ±cƒ± adƒ±" autocomplete="off">
<input class="login-input" type="password" id="loginPass" placeholder="≈ûifre" onkeydown="if(event.key==='Enter')login()">
<button class="login-btn" id="loginBtn" onclick="login()">Giri≈ü Yap</button>
</div>
</div>

<!-- PANEL -->
<div id="panel" style="display:none">
<div class="sidebar">
<div class="sidebar-logo"><h1><span>üè®</span> <span>Otel Pro</span></h1></div>
<div class="menu-item active" data-page="dashboard" onclick="nav(this,'dashboard')"><span class="icon">üìä</span><span>Ana Sayfa</span></div>
<div class="menu-item" data-page="surveys" onclick="nav(this,'surveys')"><span class="icon">üìã</span><span>Anketler</span></div>
<div class="menu-item" data-page="emails" onclick="nav(this,'emails')"><span class="icon">üìß</span><span>E-postalar</span></div>
<div class="menu-item" data-page="reports" onclick="nav(this,'reports')"><span class="icon">üìà</span><span>Raporlar</span></div>
<div class="menu-item" data-page="ai-analyses" onclick="nav(this,'ai-analyses')"><span class="icon">ü§ñ</span><span>AI Analizler</span></div>
<div class="menu-item" data-page="settings" onclick="nav(this,'settings')"><span class="icon">‚öôÔ∏è</span><span>Ayarlar</span></div>
<div class="menu-item" data-page="users" onclick="nav(this,'users')"><span class="icon">üë•</span><span>Kullanƒ±cƒ±lar</span></div>
<div class="sidebar-bottom">
<div class="user-info" onclick="openPasswordChangeModal()" style="cursor:pointer;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">
<div class="user-avatar" id="avatarInit">A</div>
<div><div class="user-name" id="curUserName">admin</div><div class="user-role" id="curUserRole">Admin</div></div>
</div>
<button class="logout-btn" onclick="logout()">‚§¥ √áƒ±kƒ±≈ü</button>
</div>
</div>

<div class="main">
<!-- DASHBOARD -->
<div id="dashboard" class="page active">
<div class="page-header"><h2>üìä Ana Sayfa</h2><p>Genel bakƒ±≈ü</p></div>
<div class="stats-grid">
<div class="stat-card"><div class="s-icon">üìã</div><div class="s-label">Toplam Anket</div><div class="s-value" id="d-total">0</div></div>
<div class="stat-card success"><div class="s-icon">‚≠ê</div><div class="s-label">Genel Ortalama</div><div class="s-value" id="d-avg">0.0</div></div>
<div class="stat-card warning"><div class="s-icon">üìÖ</div><div class="s-label">Bu Hafta</div><div class="s-value" id="d-week">0</div></div>
<div class="stat-card"><div class="s-icon">üïê</div><div class="s-label">Bug√ºn</div><div class="s-value" id="d-today">0</div></div>
</div>
<div class="quick-actions">
<div class="action-card" onclick="nav(document.querySelector('[data-page=surveys]'),'surveys')"><div class="a-icon">üìã</div><h3>Anketler</h3><p>T√ºm anketler</p></div>
<div class="action-card" onclick="nav(document.querySelector('[data-page=emails]'),'emails')"><div class="a-icon">üìß</div><h3>E-postalar</h3><p>Misafir mailleri</p></div>
<div class="action-card" onclick="nav(document.querySelector('[data-page=reports]'),'reports')"><div class="a-icon">üìà</div><h3>Raporlar</h3><p>Performans</p></div>
<div class="action-card" id="settingsQuickAction" onclick="nav(document.querySelector('[data-page=settings]'),'settings')"><div class="a-icon">‚öôÔ∏è</div><h3>Ayarlar</h3><p>Soru y√∂netimi</p></div>
</div>
<div class="chart-wrap"><h3>üìä Departman Performansƒ± (Son 30 G√ºn)</h3><div class="bar-chart" id="dashChart"></div></div>
</div>

<!-- SURVEYS -->
<div id="surveys" class="page">
<div class="page-header"><h2>üìã Anket Y√∂netimi</h2><p>T√ºm misafir anketleri</p></div>
<div class="stats-grid">
<div class="stat-card"><div class="s-label">Toplam</div><div class="s-value" id="s-total">0</div></div>
<div class="stat-card success"><div class="s-label">Ortalama</div><div class="s-value" id="s-avg">0.0</div></div>
<div class="stat-card warning"><div class="s-label">D√º≈ü√ºk (‚â§3‚òÖ)</div><div class="s-value" id="s-low">0</div></div>
<div class="stat-card"><div class="s-label">Bug√ºn</div><div class="s-value" id="s-today">0</div></div>
</div>
<div class="controls">
<button class="filter-btn active" data-filter="all" data-type="rating">T√ºm√º</button>
<button class="filter-btn" data-filter="poor" data-type="rating">D√º≈ü√ºk</button>
<button class="filter-btn" data-filter="excellent" data-type="rating">Y√ºksek</button>
<div class="divider"></div>
<button class="filter-btn" data-date="today" data-type="date">Bug√ºn</button>
<button class="filter-btn" data-date="yesterday" data-type="date">D√ºn</button>
<button class="filter-btn" data-date="week" data-type="date">Hafta</button>
<button class="filter-btn" data-date="month" data-type="date">Ay</button>
<div class="divider"></div>
<div class="ctrl-group"><label>Ba≈ülangƒ±√ß</label><input type="date" id="surveyStartDate"></div>
<div class="ctrl-group"><label>Biti≈ü</label><input type="date" id="surveyEndDate"></div>
<button class="btn btn-primary" onclick="applySurveyDateFilter()">Filtrele</button>
<button class="btn btn-success" onclick="clearSurveyDateFilter()">Temizle</button>
</div>
<div id="surveysGrid"></div>
</div>

<!-- EMAILS -->
<div id="emails" class="page">
<div class="page-header"><h2>üìß E-posta Listesi</h2><p>T√ºm misafir e-postalarƒ±</p></div>
<div id="bulkActions" class="bulk-actions">
<input type="checkbox" class="select-all-checkbox" onchange="toggleSelectAll(this)">
<span style="color:#666;font-size:14px"><strong id="selectedCount">0</strong> se√ßili</span>
<button class="btn btn-danger" onclick="deleteSelectedSurveys()">üóëÔ∏è Se√ßilileri Sil</button>
</div>
<div class="controls">
<button class="btn btn-success" onclick="exportEmails()">üì• CSV ƒ∞ndir</button>
<button class="btn btn-primary" onclick="sendBulkReviewRequest()">‚≠ê Toplu Google Yorum ƒ∞steƒüi (%90+)</button>
</div>
<div class="emails-table" id="emailsTable"></div>
</div>

<!-- REPORTS -->
<div id="reports" class="page">
<div class="page-header"><h2>üìà Departman Raporu</h2><p>Performans analizi</p></div>

<!-- Departman Bazlƒ± Detaylƒ± Rapor B√∂l√ºm√º -->
<div style="background:white;padding:20px;border-radius:14px;box-shadow:0 3px 14px rgba(0,0,0,.08)">
<h3 style="color:#1e3c72;margin-bottom:16px;font-size:18px">üéØ Departman Bazlƒ± Detaylƒ± Rapor</h3>
<div class="controls" style="margin-bottom:20px">
<div class="ctrl-group"><label>Ba≈ülangƒ±√ß</label><input type="date" id="deptStartDate"></div>
<div class="ctrl-group"><label>Biti≈ü</label><input type="date" id="deptEndDate"></div>
<div class="ctrl-group">
<label>Departman Se√ß</label>
<select id="deptSelect" style="padding:10px 16px;border-radius:8px;border:2px solid #e0e0e0;font-size:14px;min-width:200px">
<option value="">Departman se√ßin...</option>
</select>
</div>
<button class="btn btn-primary" onclick="generateDepartmentReport()">üìä Detaylƒ± Rapor Olu≈ütur</button>
<button class="pdf-export-btn" onclick="exportDepartmentReportPDF()">üìÑ PDF ƒ∞ndir</button>
<button class="btn btn-success" onclick="exportDepartmentReport()">üì• Excel ƒ∞ndir</button>
</div>
<div id="deptReportContainer"></div>
</div>

<!-- Genel Rapor B√∂l√ºm√º -->
<div id="generalReportContainer" style="background:white;padding:20px;border-radius:14px;margin-bottom:24px;box-shadow:0 3px 14px rgba(0,0,0,.08)">
<h3 style="color:#1e3c72;margin-bottom:16px;font-size:18px">üìä Genel Rapor</h3>
<div class="controls">
<div class="ctrl-group"><label>Ba≈ülangƒ±√ß</label><input type="date" id="startDate"></div>
<div class="ctrl-group"><label>Biti≈ü</label><input type="date" id="endDate"></div>
<button class="btn btn-primary" onclick="generateReport()">üìä Rapor Olu≈ütur</button>
<button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Yazdƒ±r</button>
<button class="pdf-export-btn" onclick="exportGeneralReportPDF()">üìÑ PDF ƒ∞ndir</button>
</div>
<div class="stats-grid" id="reportSummary"></div>
<div class="chart-wrap" id="reportChartWrap" style="display:none"><h3>üìä Departman Performans Grafiƒüi</h3><div class="bar-chart" id="reportChart"></div></div>
<div id="departmentsGrid"></div>
</div>
</div>

<!-- SETTINGS -->
<div id="settings" class="page">
<div class="page-header"><h2>‚öôÔ∏è Ayarlar</h2><p>Anket sorularƒ± ve sistem ayarlarƒ±</p></div>

<div class="add-user-form" style="background:#f0f9ff;border:2px solid #3b82f6">
<h3>ü§ñ AI Analiz Ayarlarƒ± (GROQ - √úcretsiz & Hƒ±zlƒ±!)</h3>
<p style="color:#666;font-size:13px;margin-bottom:12px">
Groq API Key'inizi girin. 
<a href="https://console.groq.com/keys" target="_blank" style="color:#3b82f6;font-weight:600">üëâ API Key almak i√ßin tƒ±klayƒ±n (√ºcretsiz)</a>
</p>
<div class="form-row">
<input type="text" id="groqApiKey" placeholder="gsk_..." style="flex:1">
<button class="btn btn-primary" onclick="saveGroqKey()">üíæ Kaydet</button>
</div>
<div class="login-error" id="groqKeyError" style="margin-top:12px"></div>
<div id="groqKeyStatus" style="margin-top:12px;display:none;padding:10px;background:#d1fae5;border:2px solid #10b981;border-radius:8px;color:#059669">
‚úÖ API Key kaydedildi! Artƒ±k AI analiz yapabilirsiniz. (Model: Llama 3.3 70B)
</div>
</div>

<div class="add-user-form" style="background:#fff4e6;border:2px solid #f59e0b">
<h3>üìß EmailJS Ayarlarƒ± (Mail G√∂nderimi - √úcretsiz!)</h3>
<p style="color:#666;font-size:13px;margin-bottom:12px">
EmailJS ile otomatik mail g√∂nderimi yapabilirsiniz (200 mail/ay √ºcretsiz). 
<a href="https://www.emailjs.com/" target="_blank" style="color:#f59e0b;font-weight:600">üëâ EmailJS hesabƒ± olu≈üturun</a>
</p>
<div style="display:grid;gap:12px;margin-bottom:12px">
<div class="form-row">
<input type="text" id="emailjsServiceId" placeholder="Service ID (√∂rn: service_abc123)" style="flex:1">
</div>
<div class="form-row">
<input type="text" id="emailjsTemplateId" placeholder="Template ID (√∂rn: template_xyz789)" style="flex:1">
</div>
<div class="form-row">
<input type="text" id="emailjsPublicKey" placeholder="Public Key (√∂rn: abcXYZ123)" style="flex:1">
</div>
<div class="form-row">
<input type="email" id="emailjsFromEmail" placeholder="G√∂nderici E-posta (otelden@example.com)" style="flex:1">
</div>
<div class="form-row">
<input type="text" id="emailjsFromName" placeholder="G√∂nderici Adƒ± (Noxinn Deluxe Hotel)" style="flex:1">
</div>
</div>
<button class="btn btn-primary" onclick="saveEmailJSSettings()" style="width:100%">üíæ EmailJS Ayarlarƒ±nƒ± Kaydet</button>
<div class="login-error" id="emailjsError" style="margin-top:12px"></div>
<div id="emailjsStatus" style="margin-top:12px;display:none;padding:10px;background:#d1fae5;border:2px solid #10b981;border-radius:8px;color:#059669">
‚úÖ EmailJS ayarlarƒ± kaydedildi! Artƒ±k ger√ßek mail g√∂nderebilirsiniz.
</div>
<button class="btn btn-info" onclick="testEmailJS()" style="width:100%;margin-top:12px" id="testEmailBtn">
üì§ Test Maili G√∂nder (Kendinize)
</button>
</div>

<!-- BA≈ûARI BARAJI AYARI -->
<div class="add-user-form" style="background:#fef3c7;border:2px solid #f59e0b">
<h3>üéØ Ba≈üarƒ± Y√ºzdesi Barajƒ±</h3>
<p style="color:#666;font-size:13px;margin-bottom:12px">
Ba≈üarƒ± olarak kabul edilecek minimum y√ºzdeyi belirleyin. Grafiklerde bu deƒüerin altƒ±ndaki puanlar kƒ±rmƒ±zƒ±, √ºst√ºndekiler ye≈üil g√∂r√ºn√ºr.
</p>
<div class="form-row">
<input type="number" id="successThresholdInput" placeholder="80" min="50" max="100" style="max-width:120px" value="80">
<span style="padding:10px;color:#666">%</span>
<button class="btn btn-primary" onclick="saveSuccessThreshold()">üíæ Kaydet</button>
</div>
<div class="login-error" id="thresholdError" style="margin-top:12px"></div>
<div id="thresholdStatus" style="margin-top:12px;display:none;padding:10px;background:#d1fae5;border:2px solid #10b981;border-radius:8px;color:#059669">
‚úÖ Ba≈üarƒ± barajƒ± kaydedildi!
</div>
</div>

<!-- MAƒ∞L TASLAƒûI AYARI -->
<div class="add-user-form" style="background:#f0fdfa;border:2px solid #14b8a6">
<h3>üìß Mail Taslaƒüƒ± D√ºzenleme</h3>
<p style="color:#666;font-size:13px;margin-bottom:12px">
M√º≈üterilere g√∂nderilecek Google yorum isteƒüi mailinin i√ßeriƒüini d√ºzenleyin.
<br><strong>Kullanƒ±labilir deƒüi≈ükenler:</strong> {{hotel_name}}, {{room_number}}, {{guest_name}}
</p>
<textarea id="emailTemplateTextarea" style="width:100%;min-height:200px;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;font-family:inherit" placeholder="Mail i√ßeriƒüini buraya yazƒ±n..."></textarea>
<div style="display:flex;gap:12px;margin-top:12px">
<button class="btn btn-primary" onclick="saveEmailTemplate()" style="flex:1">üíæ Kaydet</button>
<button class="btn btn-info" onclick="previewEmailTemplate()">üëÅÔ∏è √ñnizleme</button>
</div>
<div class="login-error" id="templateError" style="margin-top:12px"></div>
<div id="templateStatus" style="margin-top:12px;display:none;padding:10px;background:#d1fae5;border:2px solid #10b981;border-radius:8px;color:#059669">
‚úÖ Mail taslaƒüƒ± kaydedildi!
</div>
</div>


<div class="add-user-form">
<h3>‚ûï Yeni Soru Ekle</h3>
<div class="form-row">
<input type="text" id="newQKey" placeholder="Anahtar (dept_xyz)">
<input type="text" id="newQIcon" placeholder="Emoji" maxlength="4" style="max-width:80px">
<input type="text" id="newQName" placeholder="Soru metni">
<button class="btn btn-primary" onclick="addQuestion()">Ekle</button>
</div>
<div class="login-error" id="addQError" style="margin-top:12px"></div>
</div>
<div class="users-table" id="questionsTable"></div>
</div>

<!-- USERS -->
<div id="users" class="page">
<div class="page-header"><h2>üë• Kullanƒ±cƒ± Y√∂netimi</h2><p>Y√∂netici hesaplarƒ±</p></div>
<div class="add-user-form" id="addUserForm">
<h3>‚ûï Yeni Kullanƒ±cƒ± Ekle</h3>
<div class="form-row">
<input type="text" id="newUsername" placeholder="Kullanƒ±cƒ± adƒ±">
<input type="password" id="newPassword" placeholder="≈ûifre">
<select id="newRole"><option value="user">Kullanƒ±cƒ±</option><option value="admin">Admin</option></select>
<button class="btn btn-primary" onclick="addUser()">Ekle</button>
</div>
<div class="login-error" id="addUserError" style="margin-top:12px"></div>
</div>
<div class="users-table" id="usersTable"></div>
</div>

<!-- AI ANALIZLER -->
<div id="ai-analyses" class="page">
<div class="page-header"><h2>ü§ñ AI Analizler</h2><p>Yapay zeka destekli yorum analizi</p></div>

<div class="stats-grid" style="margin-bottom:20px">
<div class="stat-card"><div class="s-icon">ü§ñ</div><div class="s-label">Toplam Analiz</div><div class="s-value" id="ai-total">0</div></div>
<div class="stat-card danger"><div class="s-icon">üî¥</div><div class="s-label">Kritik/Y√ºksek</div><div class="s-value" id="ai-urgent">0</div></div>
<div class="stat-card warning"><div class="s-icon">üò†</div><div class="s-label">Olumsuz</div><div class="s-value" id="ai-negative">0</div></div>
<div class="stat-card success"><div class="s-icon">üòä</div><div class="s-label">Olumlu</div><div class="s-value" id="ai-positive">0</div></div>
</div>

<div class="controls" style="margin-bottom:20px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
<button class="btn btn-info" onclick="loadAIAnalyses()">üîÑ Yenile</button>

<select id="aiFilterDate" onchange="filterAIAnalyses()" style="padding:10px 16px;border-radius:8px;border:2px solid #e0e0e0;font-size:14px">
<option value="all">üìÖ T√ºm Zamanlar</option>
<option value="today">üìÖ Bug√ºn</option>
<option value="yesterday">üìÖ D√ºn</option>
<option value="week">üìÖ Bu Hafta</option>
<option value="month">üìÖ Bu Ay</option>
<option value="custom">üìÖ Tarih Aralƒ±ƒüƒ±</option>
</select>

<div id="aiCustomDateRange" style="display:none;gap:8px;align-items:center">
<input type="date" id="aiStartDate" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;font-size:13px">
<span style="color:#666">-</span>
<input type="date" id="aiEndDate" style="padding:8px;border-radius:8px;border:2px solid #e0e0e0;font-size:13px">
<button class="btn btn-primary" onclick="applyAIDateRange()" style="padding:8px 16px;font-size:13px">Uygula</button>
</div>

<select id="aiFilterUrgency" onchange="filterAIAnalyses()" style="padding:10px 16px;border-radius:8px;border:2px solid #e0e0e0;font-size:14px">
<option value="all">T√ºm √ñncelikler</option>
<option value="critical">üî¥ Kritik</option>
<option value="high">üü† Y√ºksek</option>
<option value="medium">üü° Orta</option>
<option value="low">üü¢ D√º≈ü√ºk</option>
</select>

<select id="aiFilterSentiment" onchange="filterAIAnalyses()" style="padding:10px 16px;border-radius:8px;border:2px solid #e0e0e0;font-size:14px">
<option value="all">T√ºm Duygular</option>
<option value="negative">üò† Olumsuz</option>
<option value="mixed">üòê Karƒ±≈üƒ±k</option>
<option value="neutral">üò∂ N√∂tr</option>
<option value="positive">üòä Olumlu</option>
</select>
</div>
<div id="aiAnalysesGrid"></div>
</div>
</div>
</div>

<!-- MODAL -->
<div id="reviewModal" class="modal">
<div class="modal-content">
<h3>‚≠ê Google Yorum ƒ∞steƒüi G√∂nder</h3>
<p style="margin-bottom:16px;color:#666;font-size:14px">E-posta: <strong id="modalEmail"></strong></p>
<textarea id="reviewMessage" placeholder="Mail i√ßeriƒüini d√ºzenleyin..."></textarea>
<div class="modal-buttons">
<button class="btn btn-success" onclick="sendReviewEmail()">üì§ G√∂nder</button>
<button class="btn btn-danger" onclick="closeModal()">ƒ∞ptal</button>
</div>
</div>
</div>

<!-- ≈ûƒ∞FRE DEƒûƒ∞≈ûTƒ∞RME MODAL -->
<div id="passwordChangeModal" class="modal">
<div class="modal-content">
<h3>üîí ≈ûifre Deƒüi≈ütir</h3>
<p style="margin-bottom:16px;color:#666;font-size:14px">Kullanƒ±cƒ±: <strong id="modalUsername"></strong></p>
<div class="login-error" id="passwordChangeError" style="margin-bottom:16px"></div>
<input type="password" id="currentPassword" placeholder="Mevcut ≈üifre" class="login-input" style="margin-bottom:12px">
<input type="password" id="newPassword" placeholder="Yeni ≈üifre" class="login-input" style="margin-bottom:12px">
<input type="password" id="confirmNewPassword" placeholder="Yeni ≈üifre (tekrar)" class="login-input" style="margin-bottom:16px">
<div class="modal-buttons">
<button class="btn btn-success" onclick="savePasswordChange()">üíæ Kaydet</button>
<button class="btn btn-danger" onclick="closePasswordChangeModal()">ƒ∞ptal</button>
</div>
</div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const supabase = createClient(
    'https://hxjpzgqrylmcwabkfnqc.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4anB6Z3FyeWxtY3dhYmtmbnFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1Nzk1ODksImV4cCI6MjA4NTE1NTU4OX0.YwQUuliCuxl4yc_Wqbt7UA79QYD1wxl-bmK4h1xG6Rc'
);

let DEPTS = [
    {key:'dept_beverages_service',icon:'üçπ',name:'ƒ∞√ßecekler ve Servis'},
    {key:'dept_food',icon:'üçΩÔ∏è',name:'Yiyecekler'},
    {key:'dept_cleaning',icon:'üßπ',name:'Temizlik'},
    {key:'dept_reception',icon:'üë•',name:'Resepsiyon'},
    {key:'dept_technical',icon:'üîß',name:'Teknik Servis'},
    {key:'dept_security',icon:'üõ°Ô∏è',name:'G√ºvenlik'},
    {key:'dept_return',icon:'üîÑ',name:'Bir daha gelir misiniz?'},
    {key:'dept_recommend',icon:'‚≠ê',name:'Bizi tavsiye eder misiniz?'}
];

let allSurveys = [];
let allUsers = [];
let curUser = null;
let ratingFilter = 'all';
let dateFilter = 'all';
let customDateRange = null;
let currentReviewEmail = '';

// Helper: Hem eski hem yeni format i√ßin rating al
function getRating(survey, key) {
    // √ñnce yeni format (JSON)
    if (survey.ratings && survey.ratings[key]) {
        return survey.ratings[key];
    }
    // Sonra eski format (kolon)
    if (survey[key]) {
        return survey[key];
    }
    return 0;
}

async function sha256(msg){const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(msg));return[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('')}

window.login = async function(){
    const btn=document.getElementById('loginBtn');
    const errEl=document.getElementById('loginError');
    const user=document.getElementById('loginUser').value.trim();
    const pass=document.getElementById('loginPass').value;
    if(!user||!pass)return showLoginError('Kullanƒ±cƒ± adƒ± ve ≈üifre zorunlu!');
    btn.disabled=true;errEl.classList.remove('show');
    try{
        const hash=await sha256(pass);
        const{data,error}=await supabase.from('users').select('*').eq('username',user).eq('password_hash',hash).single();
        if(error||!data)return showLoginError('Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü!');
        curUser=data;
        sessionStorage.setItem('hotel_user',JSON.stringify(curUser));
        showPanel();
    }catch(e){console.error(e);showLoginError('Baƒülantƒ± hatasƒ±!');}finally{btn.disabled=false;}
}

function showLoginError(msg){const el=document.getElementById('loginError');el.textContent='‚ö†Ô∏è '+msg;el.classList.add('show')}

function checkSession(){const stored=sessionStorage.getItem('hotel_user');if(stored){try{curUser=JSON.parse(stored);showPanel();return true}catch(e){}}return false}

async function showPanel(){
    document.getElementById('loginScreen').style.display='none';
    document.getElementById('panel').style.display='block';
    const initials=curUser.username.charAt(0).toUpperCase();
    document.getElementById('avatarInit').textContent=initials;
    document.getElementById('curUserName').textContent=curUser.username;
    document.getElementById('curUserRole').textContent=curUser.role==='admin'?'Admin':'Kullanƒ±cƒ±';
    const usersMenu=document.querySelector('[data-page=users]');
    usersMenu.style.display=curUser.role==='admin'?'flex':'none';
    const settingsMenu=document.querySelector('[data-page=settings]');
    settingsMenu.style.display=curUser.role==='admin'?'flex':'none';
    const settingsQuickAction=document.getElementById('settingsQuickAction');
    if(settingsQuickAction)settingsQuickAction.style.display=curUser.role==='admin'?'block':'none';
    await loadData();
}

window.logout=function(){sessionStorage.removeItem('hotel_user');curUser=null;document.getElementById('panel').style.display='none';document.getElementById('loginScreen').style.display='flex';document.getElementById('loginUser').value='';document.getElementById('loginPass').value=''}

async function loadQuestions(){
    try{
        const{data,error}=await supabase
            .from('survey_questions')
            .select('*')
            .eq('is_active',true)
            .order('sort_order',{ascending:true});
        if(error)throw error;
        DEPTS=data.map(q=>({key:q.key,icon:q.icon,name:q.name_tr}));
        console.log('‚úÖ Sorular y√ºklendi:',DEPTS.length);
    }catch(e){
        console.error('‚ùå Soru y√ºkleme hatasƒ±:',e);
        DEPTS=[
            {key:'dept_beverages_service',icon:'üçπ',name:'ƒ∞√ßecekler ve Servis'},
            {key:'dept_food',icon:'üçΩÔ∏è',name:'Yiyecekler'},
            {key:'dept_cleaning',icon:'üßπ',name:'Temizlik'},
            {key:'dept_reception',icon:'üë•',name:'Resepsiyon'},
            {key:'dept_technical',icon:'üîß',name:'Teknik Servis'},
            {key:'dept_security',icon:'üõ°Ô∏è',name:'G√ºvenlik'},
            {key:'dept_return',icon:'üîÑ',name:'Bir daha gelir misiniz?'},
            {key:'dept_recommend',icon:'‚≠ê',name:'Bizi tavsiye eder misiniz?'}
        ];
    }
}

async function loadData(){
    try{
        const[survRes,usrRes]=await Promise.all([
            supabase.from('surveys').select('*').order('created_at',{ascending:false}),
            supabase.from('users').select('*').order('created_at',{ascending:true})
        ]);
        allSurveys=survRes.data||[];
        allUsers=usrRes.data||[];
        await loadQuestions();
        try {
            await initEmailJS();
        } catch(emailErr) {
            console.log('EmailJS y√ºkleme atlandƒ±:', emailErr.message);
        }
        updateDashboard();updateSurveysStats();renderSurveys();renderUsers();renderEmails();renderQuestions();
    }catch(e){console.error('loadData hatasƒ±:',e)}
}

window.nav=function(el,pageId){
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.menu-item').forEach(m=>m.classList.remove('active'));
    document.getElementById(pageId).classList.add('active');
    el.classList.add('active');
    if(pageId==='reports'){
        const today=new Date();
        const ago30=new Date(today);ago30.setDate(ago30.getDate()-30);
        document.getElementById('startDate').valueAsDate=ago30;
        document.getElementById('endDate').valueAsDate=today;
        document.getElementById('deptStartDate').valueAsDate=ago30;
        document.getElementById('deptEndDate').valueAsDate=today;
        generateReport();
    }
    if(pageId==='users')renderUsers();
    if(pageId==='emails')renderEmails();
    if(pageId==='ai-analyses')loadAIAnalyses();
    if(pageId==='settings'){renderQuestions();loadGroqKey();loadEmailJSSettings();loadSuccessThreshold();loadEmailTemplate();}
}

function updateDashboard(){
    document.getElementById('d-total').textContent=allSurveys.length;
    let sum=0,cnt=0;
    allSurveys.forEach(s=>DEPTS.forEach(d=>{
        const r=getRating(s,d.key);
        if(r>0){sum+=r;cnt++;}
    }));
    document.getElementById('d-avg').textContent=cnt>0?(sum/cnt).toFixed(1):'0.0';
    const now=new Date();
    const weekAgo=new Date(now);weekAgo.setDate(weekAgo.getDate()-7);
    document.getElementById('d-week').textContent=allSurveys.filter(s=>new Date(s.created_at)>=weekAgo).length;
    const todayStr=now.toDateString();
    document.getElementById('d-today').textContent=allSurveys.filter(s=>new Date(s.created_at).toDateString()===todayStr).length;
    renderChart();
}

function renderChart(){
    const el=document.getElementById('dashChart');
    const ago=new Date();ago.setDate(ago.getDate()-30);
    const recent=allSurveys.filter(s=>new Date(s.created_at)>=ago);
    el.innerHTML=DEPTS.map(d=>{
        const ds=recent.filter(s=>getRating(s,d.key)>0);
        const pct=ds.length?Math.round(ds.reduce((a,s)=>a+getRating(s,d.key),0)/ds.length/5*100):0;
        const cls=pct>=80?'green':'red';
        return`<div class="bar ${cls}" style="height:${pct*2}px" title="${d.name}: %${pct}">
            <div class="bar-value ${cls}">%${pct}</div>
            <div class="bar-label">${d.name.length>11?d.name.slice(0,11)+'..':d.name}</div></div>`;
    }).join('');
}

function updateSurveysStats(){
    document.getElementById('s-total').textContent=allSurveys.length;
    let sum=0,cnt=0,low=0;
    allSurveys.forEach(s=>DEPTS.forEach(d=>{
        const r=getRating(s,d.key);
        if(r>0){sum+=r;cnt++;if(r<=3)low++;}
    }));
    document.getElementById('s-avg').textContent=cnt>0?(sum/cnt).toFixed(1):'0.0';
    document.getElementById('s-low').textContent=low;
    const t=new Date().toDateString();
    document.getElementById('s-today').textContent=allSurveys.filter(s=>new Date(s.created_at).toDateString()===t).length;
}

window.applySurveyDateFilter=function(){
    const sd=document.getElementById('surveyStartDate').value;
    const ed=document.getElementById('surveyEndDate').value;
    if(!sd||!ed)return alert('Tarih se√ßin!');
    customDateRange={start:new Date(sd),end:new Date(ed)};
    customDateRange.end.setHours(23,59,59,999);
    renderSurveys();
}

window.clearSurveyDateFilter=function(){
    customDateRange=null;
    document.getElementById('surveyStartDate').value='';
    document.getElementById('surveyEndDate').value='';
    renderSurveys();
}

function filterByDate(surveys,f){
    if(customDateRange){
        return surveys.filter(s=>{
            const d=new Date(s.created_at);
            return d>=customDateRange.start&&d<=customDateRange.end;
        });
    }
    if(f==='all')return surveys;
    const now=new Date();
    const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    return surveys.filter(s=>{
        const sd=new Date(s.created_at);
        const d=new Date(sd.getFullYear(),sd.getMonth(),sd.getDate());
        if(f==='today')return d.getTime()===today.getTime();
        if(f==='yesterday'){const y=new Date(today);y.setDate(y.getDate()-1);return d.getTime()===y.getTime()}
        if(f==='week'){const w=new Date(today);w.setDate(w.getDate()-7);return d>=w}
        if(f==='month'){const m=new Date(today);m.setMonth(m.getMonth()-1);return d>=m}
        return true;
    });
}

function renderSurveys(){
    const el=document.getElementById('surveysGrid');
    let filtered=allSurveys;
    if(ratingFilter==='poor')filtered=filtered.filter(s=>DEPTS.some(d=>getRating(s,d.key)>0&&getRating(s,d.key)<=3));
    if(ratingFilter==='excellent')filtered=filtered.filter(s=>DEPTS.some(d=>getRating(s,d.key)>=4));
    filtered=filterByDate(filtered,dateFilter);
    if(!filtered.length){el.innerHTML=`<div class="empty-state"><div class="e-icon">üì≠</div><h2>Anket yok</h2></div>`;return}
    const groups={};
    filtered.forEach(s=>{
        const dk=new Date(s.created_at).toLocaleDateString('tr-TR',{year:'numeric',month:'long',day:'numeric'});
        (groups[dk]=groups[dk]||[]).push(s);
    });
    const sortedKeys=Object.keys(groups).sort((a,b)=>new Date(groups[b][0].created_at)-new Date(groups[a][0].created_at));
    el.innerHTML=sortedKeys.map(dk=>{
        const list=groups[dk];
        return`<div style="margin-bottom:22px">
            <div class="date-group-header"><h3>üìÖ ${dk}</h3><span>${list.length} Anket</span></div>
            ${list.map(renderSurveyCard).join('')}
        </div>`;
    }).join('');
}

function renderSurveyCard(s){
    let sum=0,cnt=0;
    DEPTS.forEach(d=>{
        const r=getRating(s,d.key);
        if(r>0){sum+=r;cnt++;}
    });
    const avg=cnt>0?sum/cnt:0;
    const pct=(avg/5*100).toFixed(0);
    const cls=avg>=4?'excellent':avg>=3?'average':'poor';
    const time=new Date(s.created_at).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    let alert='';
    if(avg>0&&avg<=2)alert='<span class="alert-badge danger">‚ö†Ô∏è Dƒ∞KKAT</span>';
    else if(avg>2&&avg<=3)alert='<span class="alert-badge warning">‚ö†Ô∏è ƒ∞ZLE</span>';
    const stars=v=>v?'‚≠ê'.repeat(v)+'‚òÜ'.repeat(5-v):'‚îÄ';
    const isAdmin=curUser.role==='admin';
    const isHighScore=pct>=80;

    return`<div class="survey-card ${cls}">
        <div class="survey-header">
            <div>
                <div class="room-badge">Oda ${s.room_number}</div>
                <div class="badge-row">${alert}</div>
            </div>
            <div style="text-align:right">
                <div class="date-badge">${time}</div>
                ${s.email?`<div class="date-badge" style="margin-top:4px">üìß ${s.email}</div>`:''}
                <div class="badge-row" style="justify-content:flex-end;margin-top:6px">
                    ${isAdmin?`<button class="btn btn-danger" onclick="deleteSurvey('${s.id}','${s.room_number}')">Sil</button>`:''}
                    ${isHighScore&&s.email?`<button class="btn btn-info" onclick="openReviewModal('${s.email}','${s.room_number}')">‚≠ê</button>`:''}
                    <button class="btn btn-primary" onclick="analyzeWithAI('${s.id}', this)">ü§ñ Analiz Et</button>
                </div>
            </div>
        </div>
        <div class="ratings-grid">
            ${DEPTS.map(d=>`<div class="rating-item">
                <div class="r-icon">${d.icon}</div>
                <div class="r-label">${d.name.length>10?d.name.slice(0,10)+'..':d.name}</div>
                <div class="r-stars">${stars(getRating(s,d.key))}</div>
            </div>`).join('')}
        </div>
        ${s.comments?`<div class="comments-section"><div class="c-title">üìù Yorumlar</div><p>${s.comments}</p></div>`:''}
    </div>`;
}

window.deleteSurvey=async function(id,room){
    if(!confirm(`Oda ${room} anketini silmek istediƒüinizden emin misiniz?`))return;
    try{
        const{error}=await supabase.from('surveys').delete().eq('id',id);
        if(error)throw error;
        allSurveys=allSurveys.filter(s=>s.id!==id);
        updateDashboard();updateSurveysStats();renderSurveys();renderEmails();
    }catch(e){console.error(e);alert('Silme ba≈üarƒ±sƒ±z!')}
}

function renderEmails(){
    const el=document.getElementById('emailsTable');
    const emails=allSurveys.filter(s=>s.email);
    selectedSurveyIds.clear();
    document.getElementById('bulkActions').classList.remove('show');
    if(!emails.length){el.innerHTML='<div class="empty-state"><div class="e-icon">üìß</div><h2>E-posta yok</h2></div>';return}
    el.innerHTML=`<table>
        <thead><tr><th style="width:40px"><input type="checkbox" class="select-all-checkbox" onchange="toggleSelectAll(this)"></th><th>E-posta</th><th>Oda</th><th>Tarih</th><th>Ortalama Puan</th><th></th></tr></thead>
        <tbody>${emails.map(s=>{
            let sum=0,cnt=0;
            DEPTS.forEach(d=>{const r=getRating(s,d.key);if(r>0){sum+=r;cnt++;}});
            const avg=cnt>0?(sum/cnt).toFixed(1):0;
            const date=new Date(s.created_at).toLocaleDateString('tr-TR');
            const pct=cnt>0?(sum/cnt/5*100):0;
            const cls=pct>=successThreshold?'success':'danger';
            return`<tr>
                <td><input type="checkbox" class="email-checkbox" data-survey-id="${s.id}" onchange="toggleSurveySelect('${s.id}',this)"></td>
                <td><strong>${s.email}</strong></td>
                <td>${s.room_number||'-'}</td>
                <td>${date}</td>
                <td><span class="stat-badge ${cls}">‚≠ê${avg}</span></td>
                <td>
                    ${pct>=90?`<button class="btn btn-info" onclick="openReviewModal('${s.email}')">‚≠ê Yorum ƒ∞ste</button>`:' '}
                    ${curUser.role==='admin'?`<button class="btn btn-danger" onclick="deleteSurvey('${s.id}','${s.email}')">üóëÔ∏è</button>`:''}
                </td>
            </tr>`;
        }).join('')}</tbody>
    </table>`;
}

window.exportEmails=function(){
    const emails=allSurveys.filter(s=>s.email).map(s=>{
        let sum=0,cnt=0;
        DEPTS.forEach(d=>{
            const r=getRating(s,d.key);
            if(r>0){sum+=r;cnt++;}
        });
        const avg=cnt>0?(sum/cnt).toFixed(1):0;
        const date=new Date(s.created_at).toLocaleDateString('tr-TR');
        return`${s.email},${s.room_number},${date},${avg}`;
    });
    const csv='E-posta,Oda,Tarih,Puan\n'+emails.join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='emails_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();
}

window.openReviewModal=function(email,room){
    currentReviewEmail=email;
    document.getElementById('modalEmail').textContent=email;
    document.getElementById('reviewMessage').value=`Merhaba,

Noxinn Deluxe Hotel'de konaklama deneyiminizi bizimle payla≈ütƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz!

Memnuniyetinizden dolayƒ± √ßok mutluyuz. Deneyiminizi Google'da yorum yaparak diƒüer misafirlerimizle payla≈üƒ±r mƒ±sƒ±nƒ±z?

Google Yorumlarƒ±mƒ±z: https://g.page/r/YOUR_PLACE_ID/review

Zamanƒ±nƒ±z i√ßin te≈üekk√ºrler!

Sevgilerle,
Noxinn Deluxe Hotel`;
    document.getElementById('reviewModal').classList.add('show');
}

window.closeModal=function(){
    document.getElementById('reviewModal').classList.remove('show');
    currentReviewEmail='';
}

window.sendReviewEmail = async function() {
    const msg = document.getElementById('reviewMessage').value;
    
    if (!msg.trim()) {
        alert('‚ö†Ô∏è L√ºtfen mail i√ßeriƒüini yazƒ±n!');
        return;
    }
    
    // EmailJS ayarlarƒ±nƒ± kontrol et
    try {
        const { data: serviceIdData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_service_id')
            .single();
        
        const { data: templateIdData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_template_id')
            .single();
        
        const { data: publicKeyData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_public_key')
            .single();
        
        const { data: fromNameData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_from_name')
            .single();
        
        if (!serviceIdData || !templateIdData || !publicKeyData) {
            alert('‚ö†Ô∏è EmailJS ayarlarƒ± yapƒ±lmamƒ±≈ü!\n\nAyarlar sayfasƒ±ndan EmailJS bilgilerinizi girin.');
            closeModal();
            return;
        }
        
        const serviceId = serviceIdData.setting_value;
        const templateId = templateIdData.setting_value;
        const publicKey = publicKeyData.setting_value;
        const hotelName = fromNameData?.setting_value || 'Otel Y√∂netim Paneli';
        
        // EmailJS'i initialize et
        emailjs.init(publicKey);
        
        // Mail g√∂nder
        const templateParams = {
            to_email: currentReviewEmail,
            to_name: 'Deƒüerli Misafirimiz',
            subject: 'Google Yorumunuzu Bekliyoruz',
            message: msg,
            hotel_name: hotelName,
            room_number: ''
        };
        
        // Butonu disable et
        const sendBtn = event?.target;
        if (sendBtn) {
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥ G√∂nderiliyor...';
        }
        
        await emailjs.send(serviceId, templateId, templateParams);
        
        console.log('‚úÖ Mail g√∂nderildi:', currentReviewEmail);
        alert(`‚úÖ Mail ba≈üarƒ±yla g√∂nderildi!\n\n${currentReviewEmail}`);
        closeModal();
        
    } catch (error) {
        console.error('Mail g√∂nderme hatasƒ±:', error);
        alert('‚ùå Mail g√∂nderilemedi:\n\n' + (error.text || error.message));
    }
}


// ≈ûifre deƒüi≈ütirme modal fonksiyonlarƒ±
window.openPasswordChangeModal = function() {
    document.getElementById('modalUsername').textContent = curUser.username;
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    const errEl = document.getElementById('passwordChangeError');
    errEl.classList.remove('show');
    document.getElementById('passwordChangeModal').classList.add('show');
}

window.closePasswordChangeModal = function() {
    document.getElementById('passwordChangeModal').classList.remove('show');
}

window.savePasswordChange = async function() {
    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmNewPassword').value;
    const errEl = document.getElementById('passwordChangeError');
    
    errEl.classList.remove('show');
    
    // Validasyon
    if (!currentPass || !newPass || !confirmPass) {
        errEl.textContent = '‚ö†Ô∏è T√ºm alanlarƒ± doldurun!';
        errEl.classList.add('show');
        return;
    }
    
    if (newPass.length < 4) {
        errEl.textContent = '‚ö†Ô∏è Yeni ≈üifre en az 4 karakter olmalƒ±!';
        errEl.classList.add('show');
        return;
    }
    
    if (newPass !== confirmPass) {
        errEl.textContent = '‚ö†Ô∏è Yeni ≈üifreler e≈üle≈ümiyor!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        // Mevcut ≈üifreyi kontrol et
        const currentHash = await sha256(currentPass);
        if (currentHash !== curUser.password_hash) {
            errEl.textContent = '‚ö†Ô∏è Mevcut ≈üifre yanlƒ±≈ü!';
            errEl.classList.add('show');
            return;
        }
        
        // Yeni ≈üifreyi hashle ve g√ºncelle
        const newHash = await sha256(newPass);
        const { error } = await supabase
            .from('users')
            .update({ password_hash: newHash })
            .eq('id', curUser.id);
        
        if (error) throw error;
        
        // Ba≈üarƒ±lƒ±
        curUser.password_hash = newHash;
        sessionStorage.setItem('hotel_user', JSON.stringify(curUser));
        
        alert('‚úÖ ≈ûifreniz ba≈üarƒ±yla deƒüi≈ütirildi!');
        closePasswordChangeModal();
        
    } catch (error) {
        console.error('≈ûifre deƒüi≈ütirme hatasƒ±:', error);
        errEl.textContent = '‚ùå ≈ûifre deƒüi≈ütirilemedi: ' + error.message;
        errEl.classList.add('show');
    }
}

window.sendBulkReviewRequest = async function() {
    const highScores = allSurveys.filter(s => {
        if (!s.email) return false;
        let sum = 0, cnt = 0;
        DEPTS.forEach(d => {
            const r = getRating(s, d.key);
            if (r > 0) { sum += r; cnt++; }
        });
        const pct = cnt > 0 ? (sum / cnt / 5 * 100) : 0;
        return pct >= 90; // %90+ i√ßin yorum isteƒüi
    });
    
    if (!highScores.length) {
        return alert('‚ö†Ô∏è %90+ puan alan misafir yok!');
    }
    
    if (!confirm(`${highScores.length} misafire Google yorum isteƒüi g√∂ndermek istiyor musunuz?`)) {
        return;
    }
    
    // EmailJS ayarlarƒ±nƒ± kontrol et
    try {
        const { data: serviceIdData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_service_id')
            .single();
        
        const { data: templateIdData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_template_id')
            .single();
        
        const { data: publicKeyData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_public_key')
            .single();
        
        const { data: fromNameData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_from_name')
            .single();
        
        if (!serviceIdData || !templateIdData || !publicKeyData) {
            alert('‚ö†Ô∏è EmailJS ayarlarƒ± yapƒ±lmamƒ±≈ü!\n\nAyarlar sayfasƒ±ndan EmailJS bilgilerinizi girin.');
            return;
        }
        
        const serviceId = serviceIdData.setting_value;
        const templateId = templateIdData.setting_value;
        const publicKey = publicKeyData.setting_value;
        const hotelName = fromNameData?.setting_value || 'Otel Y√∂netim Paneli';
        
        emailjs.init(publicKey);
        
        const defaultMessage = emailTemplate
            .replace(/{{hotel_name}}/g, hotelName)
            .replace(/{{room_number}}/g, survey.room_number || '')
            .replace(/{{guest_name}}/g, 'Deƒüerli Misafirimiz');
        
        let successCount = 0;
        let failCount = 0;
        
        for (const survey of highScores) {
            try {
                const templateParams = {
                    to_email: survey.email,
                    to_name: 'Deƒüerli Misafirimiz',
                    subject: 'Google Yorumunuzu Bekliyoruz',
                    message: defaultMessage,
                    hotel_name: hotelName,
                    room_number: survey.room_number || ''
                };
                
                await emailjs.send(serviceId, templateId, templateParams);
                successCount++;
                console.log('‚úÖ Mail g√∂nderildi:', survey.email);
                
                // Rate limit i√ßin bekle (EmailJS free plan: 200 mail/ay, rate limit var)
                await new Promise(resolve => setTimeout(resolve, 1000));
                
            } catch (error) {
                failCount++;
                console.error('Mail g√∂nderme hatasƒ±:', survey.email, error);
            }
        }
        
        alert(`üìß Toplu mail g√∂nderimi tamamlandƒ±!\n\n‚úÖ Ba≈üarƒ±lƒ±: ${successCount}\n‚ùå Hata: ${failCount}`);
        
    } catch (error) {
        console.error('Toplu mail hatasƒ±:', error);
        alert('‚ùå Toplu mail g√∂nderilemedi:\n\n' + error.message);
    }
}

window.generateReport=function(){
    const sd=document.getElementById('startDate').value;
    const ed=document.getElementById('endDate').value;
    if(!sd||!ed)return alert('‚ö†Ô∏è Tarih se√ßin!');
    const start=new Date(sd);
    const end=new Date(ed);end.setHours(23,59,59,999);
    const filtered=allSurveys.filter(s=>{const d=new Date(s.created_at);return d>=start&&d<=end});
    if(!filtered.length){
        document.getElementById('departmentsGrid').innerHTML=`<div class="empty-state"><div class="e-icon">üì≠</div><h2>Bu aralƒ±kta anket yok</h2></div>`;
        document.getElementById('reportSummary').innerHTML='';
        document.getElementById('reportChartWrap').style.display='none';
        return;
    }
    let sum=0,cnt=0;
    filtered.forEach(s=>DEPTS.forEach(d=>{
        const r=getRating(s,d.key);
        if(r>0){sum+=r;cnt++;}
    }));
    const avg=cnt>0?(sum/cnt).toFixed(1):0;
    document.getElementById('reportSummary').innerHTML=`
        <div class="stat-card"><div class="s-label">Tarih Aralƒ±ƒüƒ±</div><div class="s-value" style="font-size:14px;color:#666">${start.toLocaleDateString('tr-TR')} ‚Äì ${end.toLocaleDateString('tr-TR')}</div></div>
        <div class="stat-card"><div class="s-label">Toplam Anket</div><div class="s-value">${filtered.length}</div></div>
        <div class="stat-card ${avg>=4?'success':avg>=3?'warning':'danger'}"><div class="s-label">Genel Ortalama</div><div class="s-value">‚≠ê ${avg}</div></div>`;

    const dData=DEPTS.map(d=>{
        const ds=filtered.filter(s=>getRating(s,d.key)>0);
        if(!ds.length)return{name:d.name,icon:d.icon,count:0,avg:0,pct:0,stars:{}};
        const total=ds.reduce((a,s)=>a+getRating(s,d.key),0);
        const avgR=total/ds.length;
        const pct=(avgR/5*100).toFixed(1);
        const stars={1:0,2:0,3:0,4:0,5:0};
        ds.forEach(s=>{
            const r=getRating(s,d.key);
            if(r>=1&&r<=5)stars[r]++;
        });
        return{name:d.name,icon:d.icon,count:ds.length,avg:avgR.toFixed(1),pct:parseFloat(pct),stars};
    }).sort((a,b)=>b.pct-a.pct);

    document.getElementById('reportChartWrap').style.display='block';
    const chartEl=document.getElementById('reportChart');
    chartEl.innerHTML=dData.map(d=>{
        const cls=d.pct>=successThreshold?'green':'red';
        return`<div class="bar ${cls}" style="height:${d.pct*2}px" title="${d.name}: %${d.pct}">
            <div class="bar-value ${cls}">%${d.pct}</div>
            <div class="bar-label">${d.name.length>11?d.name.slice(0,11)+'..':d.name}</div></div>`;
    }).join('');

    document.getElementById('departmentsGrid').innerHTML=dData.map(d=>{
        const sc=d.pct>=successThreshold?'excellent':'danger';
        const pc=d.pct>=successThreshold?'excellent':'danger';
        return`<div class="dept-card">
            <div class="dept-header"><div class="dept-name">${d.icon} ${d.name}</div><div class="dept-score ${sc}">%${d.pct}</div></div>
            ${d.count?`
                <div class="dept-details">
                    <div class="detail-item"><div class="label">Toplam</div><div class="value">${d.count}</div></div>
                    <div class="detail-item"><div class="label">Ortalama</div><div class="value">‚≠ê${d.avg}</div></div>
                    <div class="detail-item"><div class="label">5‚òÖ</div><div class="value" style="color:#10b981">${d.stars[5]}</div></div>
                    <div class="detail-item"><div class="label">4‚òÖ</div><div class="value" style="color:#3b82f6">${d.stars[4]}</div></div>
                    <div class="detail-item"><div class="label">3‚òÖ</div><div class="value" style="color:#f59e0b">${d.stars[3]}</div></div>
                    <div class="detail-item"><div class="label">1-2‚òÖ</div><div class="value" style="color:#ef4444">${(d.stars[2]||0)+(d.stars[1]||0)}</div></div>
                </div>
                <div class="progress-bar"><div class="progress-fill ${pc}" style="width:${d.pct}%">%${d.pct}</div></div>
            `:`<p style="text-align:center;color:#999;padding:16px">Deƒüerlendirme yok</p>`}
        </div>`;
    }).join('');
    populateDepartmentSelect();
}

function populateDepartmentSelect() {
    const select = document.getElementById('deptSelect');
    if (!select) return;
    select.innerHTML = '<option value="">Departman se√ßin...</option>' + 
        DEPTS.map(d => `<option value="${d.key}">${d.icon} ${d.name}</option>`).join('');
}

window.generateDepartmentReport = function() {
    const sd = document.getElementById('deptStartDate').value;
    const ed = document.getElementById('deptEndDate').value;
    const deptKey = document.getElementById('deptSelect').value;
    
    if (!sd || !ed) return alert('‚ö†Ô∏è Tarih aralƒ±ƒüƒ± se√ßin!');
    if (!deptKey) return alert('‚ö†Ô∏è Departman se√ßin!');
    
    const dept = DEPTS.find(d => d.key === deptKey);
    if (!dept) return alert('‚ö†Ô∏è Departman bulunamadƒ±!');
    
    const start = new Date(sd);
    const end = new Date(ed);
    end.setHours(23, 59, 59, 999);
    
    const filtered = allSurveys.filter(s => {
        const d = new Date(s.created_at);
        return d >= start && d <= end;
    });
    
    const deptSurveys = filtered.filter(s => getRating(s, deptKey) > 0);
    const container = document.getElementById('deptReportContainer');
    
    if (!deptSurveys.length) {
        container.innerHTML = `<div class="empty-state"><div class="e-icon">üì≠</div><h2>Bu departman i√ßin deƒüerlendirme yok</h2><p>Se√ßilen tarih aralƒ±ƒüƒ±nda "${dept.name}" departmanƒ± i√ßin anket bulunamadƒ±</p></div>`;
        return;
    }
    
    const total = deptSurveys.length;
    const ratingSum = deptSurveys.reduce((sum, s) => sum + getRating(s, deptKey), 0);
    const avgRating = (ratingSum / total).toFixed(2);
    const percentage = ((avgRating / 5) * 100).toFixed(1);
    
    const starDist = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
    deptSurveys.forEach(s => {
        const rating = getRating(s, deptKey);
        if (rating >= 1 && rating <= 5) starDist[rating]++;
    });
    
    const comments = deptSurveys.map(s => ({
        room: s.room_number,
        date: new Date(s.created_at).toLocaleDateString('tr-TR'),
        rating: getRating(s, deptKey),
        comment: s.comments || '',
        email: s.email || 'Yok'
    })).filter(c => c.comment.length > 0);
    
    const dailyData = {};
    deptSurveys.forEach(s => {
        const dateStr = new Date(s.created_at).toLocaleDateString('tr-TR');
        if (!dailyData[dateStr]) dailyData[dateStr] = {count: 0, sum: 0};
        dailyData[dateStr].count++;
        dailyData[dateStr].sum += getRating(s, deptKey);
    });
    
    const sortedDates = Object.keys(dailyData).sort((a, b) => {
        const [ad, am, ay] = a.split('.');
        const [bd, bm, by] = b.split('.');
        return new Date(ay, am-1, ad) - new Date(by, bm-1, bd);
    });
    
    container.innerHTML = `<div style="margin-bottom:24px"><div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:30px;border-radius:14px;margin-bottom:20px"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:20px"><div><h2 style="font-size:32px;margin-bottom:8px">${dept.icon} ${dept.name}</h2><p style="opacity:0.9;font-size:16px">Detaylƒ± Performans Raporu</p><p style="opacity:0.8;font-size:14px;margin-top:8px">üìÖ ${start.toLocaleDateString('tr-TR')} - ${end.toLocaleDateString('tr-TR')}</p></div><div style="text-align:right"><div style="font-size:56px;font-weight:700;line-height:1">‚≠ê${avgRating}</div><div style="font-size:24px;opacity:0.9">%${percentage}</div></div></div></div><div class="stats-grid" style="margin-bottom:24px"><div class="stat-card"><div class="s-icon">üìä</div><div class="s-label">Toplam Deƒüerlendirme</div><div class="s-value">${total}</div></div><div class="stat-card success"><div class="s-icon">‚≠ê</div><div class="s-label">Ortalama Puan</div><div class="s-value">${avgRating}</div></div><div class="stat-card ${percentage >= 80 ? 'success' : percentage >= 60 ? 'warning' : 'danger'}"><div class="s-icon">üìà</div><div class="s-label">Ba≈üarƒ± Oranƒ±</div><div class="s-value">%${percentage}</div></div><div class="stat-card ${comments.length > 0 ? 'warning' : ''}"><div class="s-icon">üí¨</div><div class="s-label">Yorum Sayƒ±sƒ±</div><div class="s-value">${comments.length}</div></div></div><div class="chart-wrap" style="margin-bottom:24px"><h3>‚≠ê Yƒ±ldƒ±z Daƒüƒ±lƒ±mƒ±</h3><div style="padding:20px 0">${[5, 4, 3, 2, 1].map(star => {const count = starDist[star];const pct = total > 0 ? ((count / total) * 100).toFixed(1) : 0;const color = star >= 4 ? '#10b981' : star === 3 ? '#f59e0b' : '#ef4444';return `<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px"><div style="min-width:60px;font-size:14px;font-weight:600">${star} ‚≠ê</div><div style="flex:1;background:#e8e8e8;height:28px;border-radius:14px;overflow:hidden"><div style="width:${pct}%;height:100%;background:${color};display:flex;align-items:center;padding:0 12px;color:white;font-weight:600;font-size:12px;transition:width 0.5s">${count > 0 ? `${count} (${pct}%)` : ''}</div></div><div style="min-width:80px;text-align:right;font-size:14px;font-weight:600;color:${color}">${count} adet</div></div>`;}).join('')}</div></div><div class="chart-wrap" style="margin-bottom:24px"><h3>üìà G√ºnl√ºk Ortalama Trend</h3><div class="bar-chart" style="height:180px">${sortedDates.map(date => {const data = dailyData[date];const avg = (data.sum / data.count).toFixed(1);const height = (avg / 5) * 100;const color = avg >= 4 ? '#10b981' : avg >= 3 ? '#f59e0b' : '#ef4444';return `<div class="bar" style="background:${color};height:${height}%;min-width:40px"><div class="bar-value" style="color:${color}">‚≠ê${avg}</div><div class="bar-label" style="font-size:9px">${date}<br>(${data.count})</div></div>`;}).join('')}</div></div>${comments.length > 0 ? `<div class="chart-wrap"><h3>üí¨ M√º≈üteri Yorumlarƒ± (${comments.length} adet)</h3><div style="max-height:500px;overflow-y:auto;padding:10px 0">${comments.map(c => `<div class="survey-card ${c.rating >= 4 ? 'excellent' : c.rating === 3 ? 'average' : 'poor'}" style="margin-bottom:14px"><div class="survey-header"><div><div class="room-badge">Oda ${c.room}</div><div class="badge-row"><div class="date-badge">${c.date}</div><div class="date-badge">‚≠ê ${c.rating}</div><div class="date-badge">üìß ${c.email}</div></div></div></div><div class="comments-section"><p>"${c.comment}"</p></div></div>`).join('')}</div></div>` : `<div class="empty-state"><div class="e-icon">üí¨</div><h3>Yorum Bulunmuyor</h3><p>Bu departman i√ßin yazƒ±lmƒ±≈ü yorum yok</p></div>`}</div>`;
}

window.exportDepartmentReport = function() {
    const deptKey = document.getElementById('deptSelect').value;
    if (!deptKey) return alert('‚ö†Ô∏è √ñnce rapor olu≈üturun!');
    
    const dept = DEPTS.find(d => d.key === deptKey);
    const sd = document.getElementById('deptStartDate').value;
    const ed = document.getElementById('deptEndDate').value;
    
    if (!sd || !ed) return alert('‚ö†Ô∏è Tarih aralƒ±ƒüƒ± se√ßin!');
    
    const start = new Date(sd);
    const end = new Date(ed);
    end.setHours(23, 59, 59, 999);
    
    const filtered = allSurveys.filter(s => {
        const d = new Date(s.created_at);
        return d >= start && d <= end;
    });
    
    const deptSurveys = filtered.filter(s => getRating(s, deptKey) > 0);
    
    if (!deptSurveys.length) return alert('‚ö†Ô∏è Veri bulunamadƒ±!');
    
    const rows = deptSurveys.map(s => {
        const date = new Date(s.created_at).toLocaleDateString('tr-TR');
        const time = new Date(s.created_at).toLocaleTimeString('tr-TR');
        const rating = getRating(s, deptKey);
        const comment = (s.comments || '').replace(/"/g, '""');
        return `"${s.room_number}","${date}","${time}","${rating}","${s.email || 'Yok'}","${comment}"`;
    });
    
    const csv = `Departman: ${dept.name}\nTarih Araligƒ±: ${start.toLocaleDateString('tr-TR')} - ${end.toLocaleDateString('tr-TR')}\n\nOda,Tarih,Saat,Puan,E-posta,Yorum\n${rows.join('\n')}`;
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${dept.name.replace(/\s+/g, '_')}_rapor_${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function renderQuestions(){
    const el=document.getElementById('questionsTable');
    if(!DEPTS.length){el.innerHTML='<div class="empty-state"><div class="e-icon">üìù</div><h2>Soru yok</h2></div>';return}
    el.innerHTML=`<table>
        <thead><tr><th>#</th><th>Emoji</th><th>Soru</th><th>Anahtar</th><th></th></tr></thead>
        <tbody>${DEPTS.map((q,i)=>`<tr>
            <td>${i+1}</td>
            <td style="font-size:20px">${q.icon}</td>
            <td><strong>${q.name}</strong></td>
            <td><code style="background:#f3f4f6;padding:3px 8px;border-radius:4px;font-size:11px">${q.key}</code></td>
            <td><button class="btn btn-danger" onclick="deleteQuestion(${i},'${q.name}')">Sil</button></td>
        </tr>`).join('')}</tbody>
    </table>`;
}

window.addQuestion=async function(){
    const key=document.getElementById('newQKey').value.trim();
    const icon=document.getElementById('newQIcon').value.trim();
    const name=document.getElementById('newQName').value.trim();
    const errEl=document.getElementById('addQError');
    errEl.classList.remove('show');
    if(!key||!icon||!name){errEl.textContent='‚ö†Ô∏è T√ºm alanlarƒ± doldurun!';errEl.classList.add('show');return}
    if(DEPTS.find(d=>d.key===key)){errEl.textContent='‚ö†Ô∏è Bu anahtar zaten var!';errEl.classList.add('show');return}
    try{
        const{data,error}=await supabase.from('survey_questions').insert([{
            key,icon,
            name_tr:name,name_en:name,name_ru:name,name_de:name,
            name_pl:name,name_cs:name,name_fr:name,name_da:name,name_ro:name,
            sort_order:DEPTS.length+1
        }]).select();
        if(error)throw error;
        DEPTS.push({key,icon,name});
        document.getElementById('newQKey').value='';
        document.getElementById('newQIcon').value='';
        document.getElementById('newQName').value='';
        renderQuestions();
        errEl.style.background='#d1fae5';errEl.style.color='#059669';errEl.style.borderColor='#10b981';
        errEl.textContent='‚úÖ Soru eklendi ve kaydedildi!';errEl.classList.add('show');
        setTimeout(()=>{errEl.classList.remove('show');errEl.style.background='#fee2e2';errEl.style.color='#dc2626';errEl.style.borderColor='#ef4444'},3000);
    }catch(e){console.error(e);errEl.textContent='‚ö†Ô∏è Soru eklenemedi: '+e.message;errEl.classList.add('show')}
}

window.deleteQuestion=async function(idx,name){
    if(!confirm(`"${name}" sorusunu silmek istediƒüinizden emin misiniz?`))return;
    try{
        const question=DEPTS[idx];
        const{error}=await supabase.from('survey_questions').delete().eq('key',question.key);
        if(error)throw error;
        DEPTS.splice(idx,1);
        renderQuestions();
        console.log('‚úÖ Soru silindi');
    }catch(e){console.error(e);alert('Silme ba≈üarƒ±sƒ±z: '+e.message)}
}

// Groq API Key kaydetme - Supabase'e kaydet
window.saveGroqKey=async function(){
    const key=document.getElementById('groqApiKey').value.trim();
    const errEl=document.getElementById('groqKeyError');
    const statusEl=document.getElementById('groqKeyStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display='none';
    
    if(!key){
        errEl.textContent='‚ö†Ô∏è API Key girin!';
        errEl.classList.add('show');
        return;
    }
    
    if(!key.startsWith('gsk_')){
        errEl.textContent='‚ö†Ô∏è Ge√ßersiz API Key formatƒ±! "gsk_..." ile ba≈ülamalƒ±.';
        errEl.classList.add('show');
        return;
    }
    
    try {
        // Veritabanƒ±na kaydet
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'groq_api_key',
                setting_value: key,
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        // Ba≈üarƒ±lƒ± mesajƒ±
        statusEl.style.display='block';
        statusEl.textContent='‚úÖ API Key kaydedildi ve t√ºm cihazlarda kullanƒ±labilir!';
        setTimeout(()=>statusEl.style.display='none',5000);
        
        console.log('‚úÖ Groq API Key veritabanƒ±na kaydedildi');
        
    } catch(e) {
        console.error('API Key kaydetme hatasƒ±:', e);
        errEl.textContent='‚ö†Ô∏è API Key kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

// Sayfa y√ºklendiƒüinde key'i Supabase'den al
async function loadGroqKey(){
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'groq_api_key')
            .single();
        
        if (error) {
            console.log('API Key bulunamadƒ±:', error.message);
            return;
        }
        
        if (data && data.setting_value) {
            document.getElementById('groqApiKey').value = data.setting_value;
            document.getElementById('groqKeyStatus').style.display = 'block';
            document.getElementById('groqKeyStatus').textContent = '‚úÖ API Key y√ºklendi (veritabanƒ±ndan)';
            console.log('‚úÖ Groq API Key veritabanƒ±ndan y√ºklendi');
        }
    } catch(e) {
        console.error('API Key y√ºkleme hatasƒ±:', e);
    }
}

// EmailJS Ayarlarƒ±
// EmailJS'i ba≈ülat (sayfa y√ºklendiƒüinde)
async function initEmailJS() {
    try {
        const { data: publicKeyData } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'emailjs_public_key')
            .single();
        
        if (publicKeyData && publicKeyData.setting_value) {
            emailjs.init(publicKeyData.setting_value);
            console.log('‚úÖ EmailJS initialized');
        }
    } catch (e) {
        console.log('EmailJS ayarlarƒ± yok (hen√ºz yapƒ±lmadƒ±)');
    }
}

async function loadEmailJSSettings() {
    console.log('üîÑ loadEmailJSSettings ba≈üladƒ±');
    try {
        // Veritabanƒ± key -> HTML input ID mapping
        const settingsMap = {
            'emailjs_service_id': 'emailjsServiceId',
            'emailjs_template_id': 'emailjsTemplateId',
            'emailjs_public_key': 'emailjsPublicKey',
            'emailjs_from_email': 'emailjsFromEmail',
            'emailjs_from_name': 'emailjsFromName'
        };
        
        console.log('üì• Veritabanƒ±ndan y√ºklenecek ayarlar:', Object.keys(settingsMap));
        
        for (const [dbKey, inputId] of Object.entries(settingsMap)) {
            const { data, error } = await supabase
                .from('ai_settings')
                .select('setting_value')
                .eq('setting_key', dbKey)
                .single();
            
            console.log(`üìä ${dbKey} yanƒ±tƒ±:`, { data, error });
            
            if (error) {
                console.log(`‚ö†Ô∏è ${dbKey} bulunamadƒ± (normal olabilir):`, error.message);
            }
            
            if (data && data.setting_value) {
                const input = document.getElementById(inputId);
                console.log(`üîç Input ID: ${inputId}, Element:`, input);
                if (input) {
                    input.value = data.setting_value;
                    console.log(`‚úÖ ${inputId} input'una deƒüer yazƒ±ldƒ±:`, data.setting_value);
                } else {
                    console.log(`‚ùå ${inputId} elementi bulunamadƒ±!`);
                }
            }
        }
        
        // Eƒüer t√ºm ayarlar y√ºklendiyse status g√∂ster
        const serviceId = document.getElementById('emailjsServiceId').value;
        console.log('üîç Y√ºklenen serviceId:', serviceId);
        if (serviceId) {
            document.getElementById('emailjsStatus').style.display = 'block';
            console.log('‚úÖ EmailJS ayarlarƒ± input\'lara y√ºklendi');
        } else {
            console.log('‚ö†Ô∏è ServiceId y√ºklenemedi, ayarlar bo≈ü olabilir');
        }
    } catch (e) {
        console.error('‚ùå EmailJS ayarlarƒ± y√ºkleme hatasƒ±:', e);
    }
}

window.saveEmailJSSettings = async function() {
    console.log('üîß saveEmailJSSettings ba≈üladƒ±');
    
    const serviceId = document.getElementById('emailjsServiceId').value.trim();
    const templateId = document.getElementById('emailjsTemplateId').value.trim();
    const publicKey = document.getElementById('emailjsPublicKey').value.trim();
    const fromEmail = document.getElementById('emailjsFromEmail').value.trim();
    const fromName = document.getElementById('emailjsFromName').value.trim();
    
    console.log('üìù Girilen deƒüerler:', { serviceId, templateId, publicKey, fromEmail, fromName });
    
    const errEl = document.getElementById('emailjsError');
    const statusEl = document.getElementById('emailjsStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (!serviceId || !templateId || !publicKey) {
        errEl.textContent = '‚ö†Ô∏è Service ID, Template ID ve Public Key zorunludur!';
        errEl.classList.add('show');
        return;
    }
    
    if (fromEmail && !fromEmail.includes('@')) {
        errEl.textContent = '‚ö†Ô∏è Ge√ßerli bir e-posta adresi girin!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const settings = [
            { key: 'emailjs_service_id', value: serviceId },
            { key: 'emailjs_template_id', value: templateId },
            { key: 'emailjs_public_key', value: publicKey },
            { key: 'emailjs_from_email', value: fromEmail },
            { key: 'emailjs_from_name', value: fromName }
        ];
        
        console.log('üíæ Kaydedilecek ayarlar:', settings);
        
        // Her ayarƒ± upsert ile kaydet
        for (const setting of settings) {
            console.log(`üìå Kaydediliyor: ${setting.key} = ${setting.value}`);
            
            const { data, error } = await supabase
                .from('ai_settings')
                .upsert({
                    setting_key: setting.key,
                    setting_value: setting.value,
                    updated_at: new Date().toISOString(),
                    updated_by: curUser.username
                }, {
                    onConflict: 'setting_key'
                })
                .select();
            
            console.log(`üìä Supabase yanƒ±tƒ± (${setting.key}):`, { data, error });
            
            if (error) {
                console.error(`‚ùå ${setting.key} kaydedilemedi:`, error);
                throw error;
            }
            
            console.log(`‚úÖ ${setting.key} ba≈üarƒ±yla kaydedildi!`);
        }
        
        // EmailJS'i initialize et
        emailjs.init(publicKey);
        console.log('‚úÖ EmailJS initialized:', publicKey);
        
        statusEl.style.display = 'block';
        statusEl.textContent = '‚úÖ EmailJS ayarlarƒ± kaydedildi ve veritabanƒ±na yazƒ±ldƒ±!';
        console.log('‚úÖ T√ºm EmailJS ayarlarƒ± ba≈üarƒ±yla kaydedildi');
        
        // 5 saniye sonra status mesajƒ±nƒ± gizle
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
    } catch (e) {
        console.error('‚ùå EmailJS ayarlarƒ± kaydetme hatasƒ±:', e);
        console.error('‚ùå Hata detayƒ±:', e.message, e.hint, e.details);
        errEl.textContent = '‚ö†Ô∏è Ayarlar kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

window.testEmailJS = async function() {
    const serviceId = document.getElementById('emailjsServiceId').value.trim();
    const templateId = document.getElementById('emailjsTemplateId').value.trim();
    const publicKey = document.getElementById('emailjsPublicKey').value.trim();
    const fromEmail = document.getElementById('emailjsFromEmail').value.trim();
    const fromName = document.getElementById('emailjsFromName').value.trim();
    
    if (!serviceId || !templateId || !publicKey) {
        alert('‚ö†Ô∏è √ñnce EmailJS ayarlarƒ±nƒ± kaydedin!');
        return;
    }
    
    if (!curUser.email && !fromEmail) {
        alert('‚ö†Ô∏è Test maili g√∂ndermek i√ßin "G√∂nderici E-posta" alanƒ±nƒ± doldurun!');
        return;
    }
    
    const testBtn = document.getElementById('testEmailBtn');
    testBtn.disabled = true;
    testBtn.textContent = '‚è≥ G√∂nderiliyor...';
    
    try {
        emailjs.init(publicKey);
        
        const templateParams = {
            to_email: fromEmail || curUser.email,
            to_name: curUser.username,
            subject: 'EmailJS Test Maili',
            message: 'Bu bir test mailidir. EmailJS entegrasyonunuz ba≈üarƒ±yla √ßalƒ±≈üƒ±yor! üéâ\n\nOtel Y√∂netim Paneli Pro',
            hotel_name: fromName || 'Otel Y√∂netim Paneli',
            room_number: 'TEST'
        };
        
        await emailjs.send(serviceId, templateId, templateParams);
        
        alert('‚úÖ Test maili ba≈üarƒ±yla g√∂nderildi!\n\n' + (fromEmail || curUser.email) + ' adresini kontrol edin.');
        
    } catch (error) {
        console.error('Test maili hatasƒ±:', error);
        alert('‚ùå Test maili g√∂nderilemedi:\n\n' + error.text);
    } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'üì§ Test Maili G√∂nder (Kendinize)';
    }
}

function renderUsers(){
    const el=document.getElementById('usersTable');
    document.getElementById('addUserForm').style.display=curUser.role==='admin'?'block':'none';
    if(!allUsers.length){el.innerHTML='<div class="empty-state"><div class="e-icon">üë•</div><h2>Kullanƒ±cƒ± yok</h2></div>';return}
    el.innerHTML=`<table>
        <thead><tr><th>#</th><th>Kullanƒ±cƒ± Adƒ±</th><th>Rol</th><th>Olu≈üturulma</th><th></th></tr></thead>
        <tbody>${allUsers.map((u,i)=>`<tr>
            <td>${i+1}</td>
            <td><strong>${u.username}</strong> ${u.id===curUser.id?'<span style="font-size:10px;color:#10b981">(Sen)</span>':''}</td>
            <td><span class="role-badge ${u.role}">${u.role==='admin'?'Admin':'Kullanƒ±cƒ±'}</span></td>
            <td>${new Date(u.created_at).toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'})}</td>
            <td>${u.id!==curUser.id&&curUser.role==='admin'?`<button class=\"btn btn-info\" onclick=\"changeUserRole('${u.id}','${u.role}')\">üîÑ Rol Deƒüi≈ütir</button> <button class=\"btn btn-danger\" onclick=\"deleteUser('${u.id}','${u.username}')\">Sil</button>`:''}}</td>
        </tr>`).join('')}</tbody>
    </table>`;
}

window.addUser=async function(){
    const username=document.getElementById('newUsername').value.trim();
    const password=document.getElementById('newPassword').value;
    const role=document.getElementById('newRole').value;
    const errEl=document.getElementById('addUserError');
    errEl.classList.remove('show');
    if(!username||!password){errEl.textContent='‚ö†Ô∏è Kullanƒ±cƒ± adƒ± ve ≈üifre zorunlu!';errEl.classList.add('show');return}
    if(password.length<4){errEl.textContent='‚ö†Ô∏è ≈ûifre en az 4 karakter!';errEl.classList.add('show');return}
    if(allUsers.find(u=>u.username===username)){errEl.textContent='‚ö†Ô∏è Bu kullanƒ±cƒ± adƒ± zaten var!';errEl.classList.add('show');return}
    try{
        const hash=await sha256(password);
        const{data,error}=await supabase.from('users').insert([{username,password_hash:hash,role}]).select();
        if(error)throw error;
        allUsers.push(data[0]);
        document.getElementById('newUsername').value='';
        document.getElementById('newPassword').value='';
        renderUsers();
    }catch(e){console.error(e);errEl.textContent='‚ö†Ô∏è Kullanƒ±cƒ± eklenemedi!';errEl.classList.add('show')}
}

window.deleteUser=async function(id,name){
    if(!confirm(`"${name}" kullanƒ±cƒ±sƒ±nƒ± silmek istediƒüinizden emin misiniz?`))return;
    try{
        const{error}=await supabase.from('users').delete().eq('id',id);
        if(error)throw error;
        allUsers=allUsers.filter(u=>u.id!==id);
        renderUsers();
    }catch(e){console.error(e);alert('Silme ba≈üarƒ±sƒ±z!')}
}

document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
        const type=btn.dataset.type;
        if(type==='rating'){
            document.querySelectorAll('[data-type=rating]').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            ratingFilter=btn.dataset.filter;
        }else{
            document.querySelectorAll('[data-type=date]').forEach(b=>b.classList.remove('active'));
            btn.classList.toggle('active',true);
            dateFilter=btn.dataset.date;
        }
        renderSurveys();
    });
});

supabase.channel('realtime-surveys')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'surveys'},p=>{
        allSurveys.unshift(p.new);
        updateDashboard();updateSurveysStats();renderSurveys();renderEmails();
        
        let sum=0,cnt=0;
        DEPTS.forEach(d=>{
            const r=getRating(p.new,d.key);
            if(r>0){sum+=r;cnt++;}
        });
        const pct=cnt>0?(sum/cnt/5*100):0;
        if(pct<80){
            console.log(`üö® D√ú≈û√úK PUAN UYARISI: Oda ${p.new.room_number} - %${pct.toFixed(0)}`);
            console.log('üìß Alert email g√∂nderilecek (SMTP config gerekli)');
        }
    })
    .subscribe();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AI ANALIZ FONKSƒ∞YONLARI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let allAIAnalyses = [];
let aiCustomDateRange = null;

window.analyzeWithAI = async function(surveyId, btnElement) {
    const survey = allSurveys.find(s => s.id === surveyId);
    if (!survey) return alert('Anket bulunamadƒ±!');
    
    // Groq API Key - Supabase'den al
    let GROQ_KEY;
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'groq_api_key')
            .single();
        
        if (error || !data || !data.setting_value) {
            return alert('‚ùå Groq API Key girilmemi≈ü!\n\nAyarlar sayfasƒ±ndan API Key ekleyin.\n\nhttps://console.groq.com/keys');
        }
        
        GROQ_KEY = data.setting_value;
    } catch(e) {
        console.error('API Key alƒ±nƒ±rken hata:', e);
        return alert('‚ùå API Key alƒ±namadƒ±: ' + e.message);
    }
    
    let sum = 0, cnt = 0;
    DEPTS.forEach(d => {
        const r = getRating(survey, d.key);
        if (r > 0) { sum += r; cnt++; }
    });
    const avgScore = cnt > 0 ? sum / cnt : 0;
    const avgPct = (avgScore / 5 * 100).toFixed(0);
    
    const btn = btnElement;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '‚è≥ Analiz ediliyor...';
    
    try {
        // Departman puanlarƒ±nƒ± hazƒ±rla
        const ratingsText = DEPTS.map(d => {
            const r = getRating(survey, d.key);
            return r > 0 ? `- ${d.name}: ${r}‚òÖ` : '';
        }).filter(Boolean).join('\n');
        
        // AI'ye g√∂nderilecek mesaj
        const userMessage = `Bir otel misafir anketini analiz et ve SADECE JSON formatƒ±nda yanƒ±t ver.

ANKET:
Oda: ${survey.room_number}
Puan: ${avgScore.toFixed(1)}/5 (%${avgPct})

Puanlar:
${ratingsText}

Yorum: "${survey.comments || 'Yorum yok'}"

SADECE bu JSON'u d√∂nd√ºr (ba≈üka a√ßƒ±klama ekleme):
{
  "sentiment": "positive/negative/neutral/mixed",
  "urgency": "low/medium/high/critical",
  "category": "cleaning/service/food/technical/reception/general",
  "summary": "T√ºrk√ße kƒ±sa √∂zet (1-2 c√ºmle)",
  "issues": [
    {"issue": "Sorun a√ßƒ±klamasƒ±", "department": "Departman", "severity": "low/medium/high", "evidence": "Kanƒ±t"}
  ],
  "recommendations": [
    {"action": "Yapƒ±lacak i≈ü", "priority": "low/medium/high/immediate", "assignTo": "Ki≈üi/Departman", "estimatedTime": "S√ºre"}
  ]
}`;

        // Groq API √ßaƒürƒ±sƒ±
        const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${GROQ_KEY}`
            },
            body: JSON.stringify({
                model: 'llama-3.3-70b-versatile',
                messages: [
                    {
                        role: 'system',
                        content: 'Sen bir otel y√∂netim asistanƒ±sƒ±n. Misafir anketlerini analiz edip JSON formatƒ±nda sonu√ß d√∂nd√ºr√ºyorsun. Sadece JSON yanƒ±t ver, ba≈üka a√ßƒ±klama ekleme.'
                    },
                    {
                        role: 'user',
                        content: userMessage
                    }
                ],
                temperature: 0.3,
                max_tokens: 1000
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error?.message || 'Groq API hatasƒ±');
        }
        
        const data = await response.json();
        const aiText = data.choices[0].message.content;
        
        // JSON parse et
        let analysis;
        try {
            const cleaned = aiText.replace(/```json\n?|\n?```/g, '').trim();
            analysis = JSON.parse(cleaned);
        } catch (e) {
            console.error('JSON parse hatasƒ±:', aiText);
            throw new Error('AI yanƒ±tƒ± JSON formatƒ±nda deƒüil: ' + aiText.substring(0, 100));
        }
        
        // √ñnce bu anket i√ßin analiz var mƒ± kontrol et
        const { data: existingAnalysis } = await supabase
            .from('ai_analyses')
            .select('id')
            .eq('survey_id', survey.id)
            .single();
        
        let savedAnalysis;
        
        if (existingAnalysis) {
            // Varsa g√ºncelle
            const { data, error: dbError } = await supabase
                .from('ai_analyses')
                .update({
                    sentiment: analysis.sentiment,
                    urgency: analysis.urgency,
                    category: analysis.category,
                    summary: analysis.summary,
                    issues: analysis.issues || [],
                    recommendations: analysis.recommendations || [],
                    model_used: 'llama-3.3-70b',
                    analyzed_at: new Date().toISOString()
                })
                .eq('survey_id', survey.id)
                .select();
            
            if (dbError) throw dbError;
            savedAnalysis = data;
            
            console.log('‚úÖ Analiz g√ºncellendi');
        } else {
            // Yoksa yeni ekle
            const { data, error: dbError } = await supabase
                .from('ai_analyses')
                .insert([{
                    survey_id: survey.id,
                    sentiment: analysis.sentiment,
                    urgency: analysis.urgency,
                    category: analysis.category,
                    summary: analysis.summary,
                    issues: analysis.issues || [],
                    recommendations: analysis.recommendations || [],
                    model_used: 'llama-3.3-70b'
                }])
                .select();
            
            if (dbError) throw dbError;
            savedAnalysis = data;
            
            console.log('‚úÖ Yeni analiz olu≈üturuldu');
        }
        
        alert(`‚úÖ AI Analizi Tamamlandƒ±!\n\n` + 
              `Duygu: ${analysis.sentiment}\n` +
              `Aciliyet: ${analysis.urgency}\n` +
              `Kategori: ${analysis.category}\n\n` +
              `√ñzet: ${analysis.summary}\n\n` +
              `${existingAnalysis ? '(Mevcut analiz g√ºncellendi)' : '(Yeni analiz olu≈üturuldu)'}\n\n` +
              `Detaylarƒ± "AI Analizler" sayfasƒ±nda g√∂rebilirsiniz.`);
        
        await loadAIAnalyses();
        
    } catch (error) {
        console.error('AI Analiz hatasƒ±:', error);
        alert(`‚ùå AI analizi ba≈üarƒ±sƒ±z:\n\n${error.message}\n\nAPI Key doƒüru mu kontrol edin.`);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

window.loadAIAnalyses = async function() {
    try {
        const { data, error } = await supabase
            .from('ai_analyses')
            .select('*, surveys(room_number, email, created_at)')
            .order('analyzed_at', { ascending: false });
        
        if (error) throw error;
        
        allAIAnalyses = data || [];
        console.log('‚úÖ AI Analizler y√ºklendi:', allAIAnalyses.length);
        updateAIStats();
        renderAIAnalyses();
    } catch (e) {
        console.error('AI analizleri y√ºkleme hatasƒ±:', e);
    }
}

function updateAIStats() {
    const total = allAIAnalyses.length;
    const urgent = allAIAnalyses.filter(a => a.urgency === 'critical' || a.urgency === 'high').length;
    const negative = allAIAnalyses.filter(a => a.sentiment === 'negative').length;
    const positive = allAIAnalyses.filter(a => a.sentiment === 'positive').length;
    
    document.getElementById('ai-total').textContent = total;
    document.getElementById('ai-urgent').textContent = urgent;
    document.getElementById('ai-negative').textContent = negative;
    document.getElementById('ai-positive').textContent = positive;
}

function renderAIAnalyses() {
    const grid = document.getElementById('aiAnalysesGrid');
    if (!grid) return;
    
    let filtered = allAIAnalyses;
    
    // Tarih filtresi
    const dateFilter = document.getElementById('aiFilterDate')?.value;
    if (dateFilter && dateFilter !== 'all') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        filtered = filtered.filter(a => {
            const date = new Date(a.analyzed_at);
            date.setHours(0, 0, 0, 0);
            
            if (dateFilter === 'today') {
                return date.getTime() === today.getTime();
            } else if (dateFilter === 'yesterday') {
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                return date.getTime() === yesterday.getTime();
            } else if (dateFilter === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                return date >= weekAgo;
            } else if (dateFilter === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setMonth(monthAgo.getMonth() - 1);
                return date >= monthAgo;
            } else if (dateFilter === 'custom' && aiCustomDateRange) {
                const start = new Date(aiCustomDateRange.start);
                const end = new Date(aiCustomDateRange.end);
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                return date >= start && date <= end;
            }
            return true;
        });
    }
    
    // Aciliyet filtresi
    const urgencyFilter = document.getElementById('aiFilterUrgency')?.value;
    if (urgencyFilter && urgencyFilter !== 'all') {
        filtered = filtered.filter(a => a.urgency === urgencyFilter);
    }
    
    // Duygu filtresi
    const sentimentFilter = document.getElementById('aiFilterSentiment')?.value;
    if (sentimentFilter && sentimentFilter !== 'all') {
        filtered = filtered.filter(a => a.sentiment === sentimentFilter);
    }
    
    if (!filtered.length) {
        grid.innerHTML = `
            <div class="empty-state">
                <div class="e-icon">ü§ñ</div>
                <h2>AI analizi yok</h2>
                <p>Se√ßilen filtrelere uygun analiz bulunamadƒ±</p>
            </div>`;
        return;
    }
    
    grid.innerHTML = filtered.map(renderAIAnalysisCard).join('');
}

function renderAIAnalysisCard(analysis) {
    const urgencyColors = {
        critical: '#ef4444',
        high: '#f97316',
        medium: '#f59e0b',
        low: '#10b981'
    };
    
    const urgencyIcons = {
        critical: 'üî¥',
        high: 'üü†',
        medium: 'üü°',
        low: 'üü¢'
    };
    
    const sentimentIcons = {
        positive: 'üòä',
        neutral: 'üò∂',
        mixed: 'üòê',
        negative: 'üò†'
    };
    
    const survey = analysis.surveys || {};
    const date = new Date(analysis.analyzed_at).toLocaleString('tr-TR');
    
    return `
        <div class="survey-card" style="border-left: 4px solid ${urgencyColors[analysis.urgency] || '#999'}">
            <div class="survey-header">
                <div>
                    <div class="room-badge">Oda ${survey.room_number || '?'}</div>
                    <div class="badge-row">
                        <span class="alert-badge" style="background:${urgencyColors[analysis.urgency] || '#999'};color:white">
                            ${urgencyIcons[analysis.urgency] || '‚ö™'} ${(analysis.urgency || 'N/A').toUpperCase()}
                        </span>
                        <span class="alert-badge" style="background:#667eea;color:white">
                            ${sentimentIcons[analysis.sentiment] || 'üò∂'} ${analysis.sentiment || 'N/A'}
                        </span>
                    </div>
                </div>
                <div style="text-align:right">
                    <div class="date-badge">${date}</div>
                    <div class="date-badge" style="margin-top:4px">üìä ${analysis.category || 'general'}</div>
                    ${curUser && curUser.role === 'admin' ? `
                        <button class="btn btn-danger" style="margin-top:8px;font-size:11px;padding:6px 12px" onclick="deleteAIAnalysis('${analysis.id}','${survey.room_number || '?'}')">
                            üóëÔ∏è Sil
                        </button>
                    ` : ''}
                </div>
            </div>
            
            <div class="comments-section">
                <div class="c-title">ü§ñ AI √ñzeti</div>
                <p><strong>${analysis.summary || '√ñzet yok'}</strong></p>
            </div>
            
            ${analysis.issues && analysis.issues.length ? `
                <div class="comments-section">
                    <div class="c-title">‚ö†Ô∏è Tespit Edilen Sorunlar (${analysis.issues.length})</div>
                    ${analysis.issues.map(issue => `
                        <div style="padding:10px;background:#fef2f2;border-radius:8px;margin:8px 0;border-left:3px solid #ef4444">
                            <strong>${issue.issue || 'Sorun'}</strong>
                            <div style="font-size:12px;color:#666;margin-top:4px">
                                üìç ${issue.department || 'N/A'} ‚Ä¢ 
                                Ciddiyet: ${issue.severity || 'N/A'}
                            </div>
                            ${issue.evidence ? `<div style="font-size:11px;color:#999;margin-top:4px;font-style:italic">"${issue.evidence}"</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            ${analysis.recommendations && analysis.recommendations.length ? `
                <div class="comments-section">
                    <div class="c-title">üí° AI √ñnerileri (${analysis.recommendations.length})</div>
                    ${analysis.recommendations.map((rec, idx) => `
                        <div style="padding:12px;background:#f0f9ff;border-radius:8px;margin:8px 0;border-left:3px solid #3b82f6">
                            <strong>${idx + 1}. ${rec.action || '√ñneri'}</strong>
                            <div style="font-size:12px;color:#666;margin-top:6px">
                                üë§ ${rec.assignTo || 'Atanmadƒ±'} ‚Ä¢ 
                                ‚è±Ô∏è ${rec.estimatedTime || 'Belirsiz'} ‚Ä¢ 
                                üéØ √ñncelik: ${rec.priority || 'N/A'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

window.filterAIAnalyses = function() {
    // Tarih aralƒ±ƒüƒ± g√∂ster/gizle
    const dateFilter = document.getElementById('aiFilterDate')?.value;
    const customRange = document.getElementById('aiCustomDateRange');
    
    if (dateFilter === 'custom') {
        customRange.style.display = 'flex';
        // Bug√ºn√ºn tarihini varsayƒ±lan olarak ayarla
        const today = new Date().toISOString().split('T')[0];
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        document.getElementById('aiStartDate').value = weekAgo.toISOString().split('T')[0];
        document.getElementById('aiEndDate').value = today;
    } else {
        customRange.style.display = 'none';
        aiCustomDateRange = null;
    }
    
    renderAIAnalyses();
}

// √ñzel tarih aralƒ±ƒüƒ±nƒ± uygula
window.applyAIDateRange = function() {
    const startDate = document.getElementById('aiStartDate').value;
    const endDate = document.getElementById('aiEndDate').value;
    
    if (!startDate || !endDate) {
        alert('‚ö†Ô∏è L√ºtfen ba≈ülangƒ±√ß ve biti≈ü tarihlerini se√ßin!');
        return;
    }
    
    if (new Date(startDate) > new Date(endDate)) {
        alert('‚ö†Ô∏è Ba≈ülangƒ±√ß tarihi biti≈ü tarihinden √∂nce olmalƒ±!');
        return;
    }
    
    aiCustomDateRange = { start: startDate, end: endDate };
    renderAIAnalyses();
}

// AI Analiz silme (sadece admin)
window.deleteAIAnalysis = async function(analysisId, roomNumber) {
    if (!curUser || curUser.role !== 'admin') {
        return alert('‚ùå Sadece adminler AI analizlerini silebilir!');
    }
    
    if (!confirm(`Oda ${roomNumber} i√ßin AI analizini silmek istediƒüinizden emin misiniz?\n\nBu i≈ülem geri alƒ±namaz!`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_analyses')
            .delete()
            .eq('id', analysisId);
        
        if (error) throw error;
        
        // Local listeden kaldƒ±r
        allAIAnalyses = allAIAnalyses.filter(a => a.id !== analysisId);
        
        // Sayfayƒ± yenile
        renderAIAnalyses();
        
        console.log('‚úÖ AI analizi silindi:', analysisId);
        
        // Ba≈üarƒ± mesajƒ±
        alert('‚úÖ AI analizi ba≈üarƒ±yla silindi!');
        
    } catch (error) {
        console.error('AI analiz silme hatasƒ±:', error);
        alert('‚ùå AI analizi silinemedi:\n\n' + error.message);
    }
}

if(!checkSession()){}
// ============================================
// OTEL Y√ñNETƒ∞M PANELƒ∞ V2.0 - YENƒ∞ √ñZELLƒ∞KLER
// ============================================

// Global deƒüi≈ükenler
let successThreshold = 80; // Ba≈üarƒ± barajƒ±
let emailTemplate = ''; // Mail taslaƒüƒ±
let selectedSurveyIds = new Set(); // Se√ßili anketler

// ============================================
// 1. KULLANICI YETKƒ∞ Y√ñNETƒ∞Mƒ∞
// ============================================

window.changeUserRole = async function(userId, currentRole) {
    const newRole = currentRole === 'admin' ? 'user' : 'admin';
    const user = allUsers.find(u => u.id === userId);
    
    if (!confirm(`"${user.username}" kullanƒ±cƒ±sƒ±nƒ±n rol√ºn√º "${currentRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" -> "${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}" olarak deƒüi≈ütirmek istiyor musunuz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('users')
            .update({ role: newRole })
            .eq('id', userId);
        
        if (error) throw error;
        
        // Local state'i g√ºncelle
        user.role = newRole;
        renderUsers();
        alert(`‚úÖ ${user.username} artƒ±k ${newRole === 'admin' ? 'Admin' : 'Kullanƒ±cƒ±'}`);
        
    } catch (e) {
        console.error('Rol deƒüi≈ütirme hatasƒ±:', e);
        alert('‚ùå Rol deƒüi≈ütirilemedi: ' + e.message);
    }
}

// ============================================
// 2. PDF EXPORT FONKSƒ∞YONLARI
// ============================================

window.exportGeneralReportPDF = async function() {
    const element = document.getElementById('generalReportContainer');
    if (!element) {
        alert('‚ö†Ô∏è √ñnce rapor olu≈üturun!');
        return;
    }
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`Genel_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

window.exportDepartmentReportPDF = async function() {
    const element = document.getElementById('deptReportContainer');
    if (!element || !element.innerHTML) {
        alert('‚ö†Ô∏è √ñnce departman raporu olu≈üturun!');
        return;
    }
    
    const deptKey = document.getElementById('deptSelect').value;
    const dept = DEPTS.find(d => d.key === deptKey);
    
    try {
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgWidth = 210;
        const pageHeight = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        pdf.save(`${dept.name}_Rapor_${new Date().toISOString().slice(0, 10)}.pdf`);
        
    } catch (e) {
        console.error('PDF export hatasƒ±:', e);
        alert('‚ùå PDF olu≈üturulamadƒ±');
    }
}

// ============================================
// 3. BA≈ûARI BARAJI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadSuccessThreshold() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'success_threshold')
            .single();
        
        if (data && data.setting_value) {
            successThreshold = parseInt(data.setting_value);
            const input = document.getElementById('successThresholdInput');
            if (input) input.value = successThreshold;
            console.log('‚úÖ Ba≈üarƒ± barajƒ± y√ºklendi:', successThreshold);
        }
    } catch (e) {
        console.log('Ba≈üarƒ± barajƒ± ayarƒ± yok, varsayƒ±lan kullanƒ±lƒ±yor:', successThreshold);
    }
}

window.saveSuccessThreshold = async function() {
    const value = parseInt(document.getElementById('successThresholdInput').value);
    const errEl = document.getElementById('thresholdError');
    const statusEl = document.getElementById('thresholdStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (isNaN(value) || value < 50 || value > 100) {
        errEl.textContent = '‚ö†Ô∏è Ba≈üarƒ± barajƒ± 50-100 arasƒ±nda olmalƒ±!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'success_threshold',
                setting_value: value.toString(),
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        successThreshold = value;
        statusEl.style.display = 'block';
        statusEl.textContent = `‚úÖ Ba≈üarƒ± barajƒ± %${value} olarak kaydedildi!`;
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
        // Raporlarƒ± yenile
        if (document.getElementById('reports').classList.contains('active')) {
            generateReport();
        }
        
    } catch (e) {
        console.error('Ba≈üarƒ± barajƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

// ============================================
// 4. MAƒ∞L Sƒ∞LME FONKSƒ∞YONLARI
// ============================================

window.toggleSurveySelect = function(surveyId, checkbox) {
    if (checkbox.checked) {
        selectedSurveyIds.add(surveyId);
    } else {
        selectedSurveyIds.delete(surveyId);
    }
    
    // Toplu silme butonunu g√∂ster/gizle
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.toggleSelectAll = function(checkbox) {
    const checkboxes = document.querySelectorAll('.email-checkbox');
    selectedSurveyIds.clear();
    
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
        if (checkbox.checked) {
            selectedSurveyIds.add(cb.dataset.surveyId);
        }
    });
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedSurveyIds.size > 0) {
        bulkActions.classList.add('show');
        selectedCount.textContent = selectedSurveyIds.size;
    } else {
        bulkActions.classList.remove('show');
    }
}

window.deleteSurvey = async function(surveyId, email) {
    if (!confirm(`"${email}" adresine ait anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('surveys')
            .delete()
            .eq('id', surveyId);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => s.id !== surveyId);
        selectedSurveyIds.delete(surveyId);
        
        renderEmails();
        updateDashboard();
        alert('‚úÖ Anket silindi!');
        
    } catch (e) {
        console.error('Anket silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

window.deleteSelectedSurveys = async function() {
    if (selectedSurveyIds.size === 0) return;
    
    if (!confirm(`${selectedSurveyIds.size} anketi silmek istediƒüinize emin misiniz?`)) {
        return;
    }
    
    try {
        const idsArray = Array.from(selectedSurveyIds);
        
        const { error } = await supabase
            .from('surveys')
            .delete()
            .in('id', idsArray);
        
        if (error) throw error;
        
        // Local state'ten kaldƒ±r
        allSurveys = allSurveys.filter(s => !selectedSurveyIds.has(s.id));
        selectedSurveyIds.clear();
        
        renderEmails();
        updateDashboard();
        alert(`‚úÖ ${idsArray.length} anket silindi!`);
        
    } catch (e) {
        console.error('Toplu silme hatasƒ±:', e);
        alert('‚ùå Silinemedi: ' + e.message);
    }
}

// ============================================
// 5. MAƒ∞L TASLAƒûI Y√ñNETƒ∞Mƒ∞
// ============================================

async function loadEmailTemplate() {
    try {
        const { data, error } = await supabase
            .from('ai_settings')
            .select('setting_value')
            .eq('setting_key', 'email_template')
            .single();
        
        if (data && data.setting_value) {
            emailTemplate = data.setting_value;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
            console.log('‚úÖ Mail taslaƒüƒ± y√ºklendi');
        } else {
            // Varsayƒ±lan taslak
            emailTemplate = `Merhaba,

{{hotel_name}}'de konaklama deneyiminizi bizimle payla≈ütƒ±ƒüƒ±nƒ±z i√ßin te≈üekk√ºr ederiz!

Memnuniyetinizden dolayƒ± √ßok mutluyuz. Deneyiminizi Google'da yorum yaparak diƒüer misafirlerimizle payla≈üƒ±r mƒ±sƒ±nƒ±z?

Google Yorumlarƒ±mƒ±z: https://g.page/r/YOUR_PLACE_ID/review

Zamanƒ±nƒ±z i√ßin te≈üekk√ºrler!

Sevgilerle,
{{hotel_name}}`;
            const textarea = document.getElementById('emailTemplateTextarea');
            if (textarea) textarea.value = emailTemplate;
        }
    } catch (e) {
        console.log('Mail taslaƒüƒ± y√ºkleme hatasƒ±:', e);
    }
}

window.saveEmailTemplate = async function() {
    const value = document.getElementById('emailTemplateTextarea').value.trim();
    const errEl = document.getElementById('templateError');
    const statusEl = document.getElementById('templateStatus');
    
    errEl.classList.remove('show');
    statusEl.style.display = 'none';
    
    if (!value) {
        errEl.textContent = '‚ö†Ô∏è Mail taslaƒüƒ± bo≈ü olamaz!';
        errEl.classList.add('show');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('ai_settings')
            .upsert({
                setting_key: 'email_template',
                setting_value: value,
                updated_at: new Date().toISOString(),
                updated_by: curUser.username
            }, {
                onConflict: 'setting_key'
            });
        
        if (error) throw error;
        
        emailTemplate = value;
        statusEl.style.display = 'block';
        statusEl.textContent = '‚úÖ Mail taslaƒüƒ± kaydedildi!';
        setTimeout(() => statusEl.style.display = 'none', 5000);
        
    } catch (e) {
        console.error('Mail taslaƒüƒ± kaydetme hatasƒ±:', e);
        errEl.textContent = '‚ö†Ô∏è Kaydedilemedi: ' + e.message;
        errEl.classList.add('show');
    }
}

window.previewEmailTemplate = function() {
    const template = document.getElementById('emailTemplateTextarea').value;
    const hotelName = document.getElementById('emailjsFromName').value || 'Noxinn Deluxe Hotel';
    
    const preview = template
        .replace(/{{hotel_name}}/g, hotelName)
        .replace(/{{room_number}}/g, '101')
        .replace(/{{guest_name}}/g, 'Sayƒ±n Misafirimiz');
    
    alert(`üìß Mail √ñnizleme:\n\n${preview}`);
}

// ============================================
// SAYFA Y√úKLENME OLAYLARI
// ============================================



// ƒ∞lk y√ºklemede ayarlarƒ± y√ºkle
window.addEventListener('DOMContentLoaded', () => {
    loadSuccessThreshold();
    loadEmailTemplate();
});

</script>
</body>
</html>
